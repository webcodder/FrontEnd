(function(r){var n={};function i(e){if(n[e]){return n[e].exports}var t=n[e]={i:e,l:false,exports:{}};r[e].call(t.exports,t,t.exports,i);t.l=true;return t.exports}i.m=r;i.c=n;i.d=function(e,t,r){if(!i.o(e,t)){Object.defineProperty(e,t,{configurable:false,enumerable:true,get:r})}};i.n=function(t){var e=t&&t.__esModule?function e(){return t["default"]}:function e(){return t};i.d(e,"a",e);return e};i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};i.p="";return i(i.s=9)})([function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(1,eval)("this")}catch(e){if(typeof window==="object")r=window}e.exports=r},,,,function(r,e,t){(function(i){var u;var u;(function(e){if(true){r.exports=e()}else if(typeof define==="function"&&define.amd){define([],e)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof i!=="undefined"){t=i}else if(typeof self!=="undefined"){t=self}else{t=this}t.adapter=e()}})(function(){var e,t,r;return function o(a,s,c){function l(r,e){if(!s[r]){if(!a[r]){var t=typeof u=="function"&&u;if(!e&&t)return u(r,!0);if(d)return d(r,!0);var n=new Error("Cannot find module '"+r+"'");throw n.code="MODULE_NOT_FOUND",n}var i=s[r]={exports:{}};a[r][0].call(i.exports,function(e){var t=a[r][1][e];return l(t?t:e)},i,i.exports,o,a,s,c)}return s[r].exports}var d=typeof u=="function"&&u;for(var e=0;e<c.length;e++)l(c[e]);return l}({1:[function(e,t,r){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};d.localCName=d.generateIdentifier();d.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})};d.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})};d.getDescription=function(e){var t=d.splitSections(e);return t&&t[0]};d.getMediaSections=function(e){var t=d.splitSections(e);t.shift();return t};d.matchPrefix=function(e,t){return d.splitLines(e).filter(function(e){return e.indexOf(t)===0})};d.parseCandidate=function(e){var t;if(e.indexOf("a=candidate:")===0){t=e.substring(12).split(" ")}else{t=e.substring(10).split(" ")}var r={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]};for(var n=8;n<t.length;n+=2){switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1];r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];break}}return r};d.writeCandidate=function(e){var t=[];t.push(e.foundation);t.push(e.component);t.push(e.protocol.toUpperCase());t.push(e.priority);t.push(e.ip);t.push(e.port);var r=e.type;t.push("typ");t.push(r);if(r!=="host"&&e.relatedAddress&&e.relatedPort){t.push("raddr");t.push(e.relatedAddress);t.push("rport");t.push(e.relatedPort)}if(e.tcpType&&e.protocol.toLowerCase()==="tcp"){t.push("tcptype");t.push(e.tcpType)}if(e.ufrag){t.push("ufrag");t.push(e.ufrag)}return"candidate:"+t.join(" ")};d.parseIceOptions=function(e){return e.substr(14).split(" ")};d.parseRtpMap=function(e){var t=e.substr(9).split(" ");var r={payloadType:parseInt(t.shift(),10)};t=t[0].split("/");r.name=t[0];r.clockRate=parseInt(t[1],10);r.numChannels=t.length===3?parseInt(t[2],10):1;return r};d.writeRtpMap=function(e){var t=e.payloadType;if(e.preferredPayloadType!==undefined){t=e.preferredPayloadType}return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(e.numChannels!==1?"/"+e.numChannels:"")+"\r\n"};d.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}};d.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+"\r\n"};d.parseFmtp=function(e){var t={};var r;var n=e.substr(e.indexOf(" ")+1).split(";");for(var i=0;i<n.length;i++){r=n[i].trim().split("=");t[r[0].trim()]=r[1]}return t};d.writeFmtp=function(t){var e="";var r=t.payloadType;if(t.preferredPayloadType!==undefined){r=t.preferredPayloadType}if(t.parameters&&Object.keys(t.parameters).length){var n=[];Object.keys(t.parameters).forEach(function(e){n.push(e+"="+t.parameters[e])});e+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return e};d.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};d.writeRtcpFb=function(e){var t="";var r=e.payloadType;if(e.preferredPayloadType!==undefined){r=e.preferredPayloadType}if(e.rtcpFeedback&&e.rtcpFeedback.length){e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})}return t};d.parseSsrcMedia=function(e){var t=e.indexOf(" ");var r={ssrc:parseInt(e.substr(7,t-7),10)};var n=e.indexOf(":",t);if(n>-1){r.attribute=e.substr(t+1,n-t-1);r.value=e.substr(n+1)}else{r.attribute=e.substr(t+1)}return r};d.getMid=function(e){var t=d.matchPrefix(e,"a=mid:")[0];if(t){return t.substr(6)}};d.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}};d.getDtlsParameters=function(e,t){var r=d.matchPrefix(e+t,"a=fingerprint:");return{role:"auto",fingerprints:r.map(d.parseFingerprint)}};d.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"});return r};d.getIceParameters=function(e,t){var r=d.splitLines(e);r=r.concat(d.splitLines(t));var n={usernameFragment:r.filter(function(e){return e.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:r.filter(function(e){return e.indexOf("a=ice-pwd:")===0})[0].substr(10)};return n};d.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\n"+"a=ice-pwd:"+e.password+"\r\n"};d.parseRtpParameters=function(e){var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var r=d.splitLines(e);var n=r[0].split(" ");for(var i=3;i<n.length;i++){var o=n[i];var a=d.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=d.parseRtpMap(a);var c=d.matchPrefix(e,"a=fmtp:"+o+" ");s.parameters=c.length?d.parseFmtp(c[0]):{};s.rtcpFeedback=d.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(d.parseRtcpFb);t.codecs.push(s);switch(s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase());break;default:break}}}d.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(d.parseExtmap(e))});return t};d.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ";r+=t.codecs.length>0?"9":"0";r+=" UDP/TLS/RTP/SAVPF ";r+=t.codecs.map(function(e){if(e.preferredPayloadType!==undefined){return e.preferredPayloadType}return e.payloadType}).join(" ")+"\r\n";r+="c=IN IP4 0.0.0.0\r\n";r+="a=rtcp:9 IN IP4 0.0.0.0\r\n";t.codecs.forEach(function(e){r+=d.writeRtpMap(e);r+=d.writeFmtp(e);r+=d.writeRtcpFb(e)});var n=0;t.codecs.forEach(function(e){if(e.maxptime>n){n=e.maxptime}});if(n>0){r+="a=maxptime:"+n+"\r\n"}r+="a=rtcp-mux\r\n";t.headerExtensions.forEach(function(e){r+=d.writeExtmap(e)});return r};d.parseRtpEncodingParameters=function(e){var r=[];var t=d.parseRtpParameters(e);var n=t.fecMechanisms.indexOf("RED")!==-1;var i=t.fecMechanisms.indexOf("ULPFEC")!==-1;var o=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"});var a=o.length>0&&o[0].ssrc;var s;var c=d.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");t.shift();return t.map(function(e){return parseInt(e,10)})});if(c.length>0&&c[0].length>1&&c[0][0]===a){s=c[0][1]}t.codecs.forEach(function(e){if(e.name.toUpperCase()==="RTX"&&e.parameters.apt){var t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{ssrc:s}};r.push(t);if(n){t=JSON.parse(JSON.stringify(t));t.fec={ssrc:s,mechanism:i?"red+ulpfec":"red"};r.push(t)}}});if(r.length===0&&a){r.push({ssrc:a})}var l=d.matchPrefix(e,"b=");if(l.length){if(l[0].indexOf("b=TIAS:")===0){l=parseInt(l[0].substr(7),10)}else if(l[0].indexOf("b=AS:")===0){l=parseInt(l[0].substr(5),10)*1e3*.95-50*40*8}else{l=undefined}r.forEach(function(e){e.maxBitrate=l})}return r};d.parseRtcpParameters=function(e){var t={};var r;var n=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"})[0];if(n){t.cname=n.value;t.ssrc=n.ssrc}var i=d.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0;t.compound=i.length===0;var o=d.matchPrefix(e,"a=rtcp-mux");t.mux=o.length>0;return t};d.parseMsid=function(e){var t;var r=d.matchPrefix(e,"a=msid:");if(r.length===1){t=r[0].substr(7).split(" ");return{stream:t[0],track:t[1]}}var n=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="msid"});if(n.length>0){t=n[0].value.split(" ");return{stream:t[0],track:t[1]}}};d.generateSessionId=function(){return Math.random().toString().substr(2,21)};d.writeSessionBoilerplate=function(e,t){var r;var n=t!==undefined?t:2;if(e){r=e}else{r=d.generateSessionId()}return"v=0\r\n"+"o=thisisadapterortc "+r+" "+n+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};d.writeMediaSection=function(e,t,r,n){var i=d.writeRtpDescription(e.kind,t);i+=d.writeIceParameters(e.iceGatherer.getLocalParameters());i+=d.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),r==="offer"?"actpass":"active");i+="a=mid:"+e.mid+"\r\n";if(e.direction){i+="a="+e.direction+"\r\n"}else if(e.rtpSender&&e.rtpReceiver){i+="a=sendrecv\r\n"}else if(e.rtpSender){i+="a=sendonly\r\n"}else if(e.rtpReceiver){i+="a=recvonly\r\n"}else{i+="a=inactive\r\n"}if(e.rtpSender){var o="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o;i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o;if(e.sendEncodingParameters[0].rtx){i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o;i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n";if(e.rtpSender&&e.sendEncodingParameters[0].rtx){i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"}return i};d.getDirection=function(e,t){var r=d.splitLines(e);for(var n=0;n<r.length;n++){switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2);default:}}if(t){return d.getDirection(t)}return"sendrecv"};d.getKind=function(e){var t=d.splitLines(e);var r=t[0].split(" ");return r[0].substr(2)};d.isRejected=function(e){return e.split(" ",2)[1]==="0"};d.parseMLine=function(e){var t=d.splitLines(e);var r=t[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}};d.parseOLine=function(e){var t=d.matchPrefix(e,"o=")[0];var r=t.substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}};if(typeof t==="object"){t.exports=d}},{}],2:[function(e,t,r){"use strict";var x=e("sdp");function c(e,t,r,n,i){var o=x.writeRtpDescription(e.kind,t);o+=x.writeIceParameters(e.iceGatherer.getLocalParameters());o+=x.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),r==="offer"?"actpass":i||"active");o+="a=mid:"+e.mid+"\r\n";if(e.rtpSender&&e.rtpReceiver){o+="a=sendrecv\r\n"}else if(e.rtpSender){o+="a=sendonly\r\n"}else if(e.rtpReceiver){o+="a=recvonly\r\n"}else{o+="a=inactive\r\n"}if(e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var s="msid:"+(n?n.id:"-")+" "+a+"\r\n";o+="a="+s;o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s;if(e.sendEncodingParameters[0].rtx){o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s;o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+x.localCName+"\r\n";if(e.rtpSender&&e.sendEncodingParameters[0].rtx){o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+x.localCName+"\r\n"}return o}function o(e,n){var i=false;e=JSON.parse(JSON.stringify(e));return e.filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;if(e.url&&!e.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var r=typeof t==="string";if(r){t=[t]}t=t.filter(function(e){var t=e.indexOf("turn:")===0&&e.indexOf("transport=udp")!==-1&&e.indexOf("turn:[")===-1&&!i;if(t){i=true;return true}return e.indexOf("stun:")===0&&n>=14393&&e.indexOf("?transport=udp")===-1});delete e.url;e.urls=r?t[0]:t;return!!t.length}})}function v(n,i){var o={codecs:[],headerExtensions:[],fecMechanisms:[]};var a=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++){if(t[r].payloadType===e||t[r].preferredPayloadType===e){return t[r]}}};var s=function(e,t,r,n){var i=a(e.parameters.apt,r);var o=a(t.parameters.apt,n);return i&&o&&i.name.toLowerCase()===o.name.toLowerCase()};n.codecs.forEach(function(r){for(var e=0;e<i.codecs.length;e++){var t=i.codecs[e];if(r.name.toLowerCase()===t.name.toLowerCase()&&r.clockRate===t.clockRate){if(r.name.toLowerCase()==="rtx"&&r.parameters&&t.parameters.apt){if(!s(r,t,n.codecs,i.codecs)){continue}}t=JSON.parse(JSON.stringify(t));t.numChannels=Math.min(r.numChannels,t.numChannels);o.codecs.push(t);t.rtcpFeedback=t.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++){if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter){return true}}return false});break}}});n.headerExtensions.forEach(function(e){for(var t=0;t<i.headerExtensions.length;t++){var r=i.headerExtensions[t];if(e.uri===r.uri){o.headerExtensions.push(r);break}}});return o}function a(e,t,r){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)!==-1}function U(e,t){var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});if(!r){e.addRemoteCandidate(t)}return!r}function u(e,t){var r=new Error(t);r.name=e;r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:undefined,OperationError:undefined}[e];return r}t.exports=function(A,N){function W(e,t){t.addTrack(e);t.dispatchEvent(new A.MediaStreamTrackEvent("addtrack",{track:e}))}function M(e,t){t.removeTrack(e);t.dispatchEvent(new A.MediaStreamTrackEvent("removetrack",{track:e}))}function i(e,t,r,n){var i=new Event("track");i.track=t;i.receiver=r;i.transceiver={receiver:r};i.streams=n;A.setTimeout(function(){e._dispatchEvent("track",i)})}var n=function(e){var t=this;var r=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=r[e].bind(r)});this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this.localDescription=null;this.remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.connectionState="new";this.iceGatheringState="new";e=JSON.parse(JSON.stringify(e||{}));this.usingBundle=e.bundlePolicy==="max-bundle";if(e.rtcpMuxPolicy==="negotiate"){throw u("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported")}else if(!e.rtcpMuxPolicy){e.rtcpMuxPolicy="require"}switch(e.iceTransportPolicy){case"all":case"relay":break;default:e.iceTransportPolicy="all";break}switch(e.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:e.bundlePolicy="balanced";break}e.iceServers=o(e.iceServers||[],N);this._iceGatherers=[];if(e.iceCandidatePoolSize){for(var n=e.iceCandidatePoolSize;n>0;n--){this._iceGatherers.push(new A.RTCIceGatherer({iceServers:e.iceServers,gatherPolicy:e.iceTransportPolicy}))}}else{e.iceCandidatePoolSize=0}this._config=e;this.transceivers=[];this._sdpSessionId=x.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=undefined;this._isClosed=false};n.prototype.onicecandidate=null;n.prototype.onaddstream=null;n.prototype.ontrack=null;n.prototype.onremovestream=null;n.prototype.onsignalingstatechange=null;n.prototype.oniceconnectionstatechange=null;n.prototype.onconnectionstatechange=null;n.prototype.onicegatheringstatechange=null;n.prototype.onnegotiationneeded=null;n.prototype.ondatachannel=null;n.prototype._dispatchEvent=function(e,t){if(this._isClosed){return}this.dispatchEvent(t);if(typeof this["on"+e]==="function"){this["on"+e](t)}};n.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)};n.prototype.getConfiguration=function(){return this._config};n.prototype.getLocalStreams=function(){return this.localStreams};n.prototype.getRemoteStreams=function(){return this.remoteStreams};n.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0;var n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&r){n.iceTransport=this.transceivers[0].iceTransport;n.dtlsTransport=this.transceivers[0].dtlsTransport}else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport;n.dtlsTransport=i.dtlsTransport}if(!t){this.transceivers.push(n)}return n};n.prototype.addTrack=function(t,e){if(this._isClosed){throw u("InvalidStateError","Attempted to call addTrack on a closed peerconnection.")}var r=this.transceivers.find(function(e){return e.track===t});if(r){throw u("InvalidAccessError","Track already exists.")}var n;for(var i=0;i<this.transceivers.length;i++){if(!this.transceivers[i].track&&this.transceivers[i].kind===t.kind){n=this.transceivers[i]}}if(!n){n=this._createTransceiver(t.kind)}this._maybeFireNegotiationNeeded();if(this.localStreams.indexOf(e)===-1){this.localStreams.push(e)}n.track=t;n.stream=e;n.rtpSender=new A.RTCRtpSender(t,n.dtlsTransport);return n.rtpSender};n.prototype.addStream=function(t){var r=this;if(N>=15025){t.getTracks().forEach(function(e){r.addTrack(e,t)})}else{var n=t.clone();t.getTracks().forEach(function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})});n.getTracks().forEach(function(e){r.addTrack(e,n)})}};n.prototype.removeTrack=function(t){if(this._isClosed){throw u("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.")}if(!(t instanceof A.RTCRtpSender)){throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.")}var e=this.transceivers.find(function(e){return e.rtpSender===t});if(!e){throw u("InvalidAccessError","Sender was not created by this connection.")}var r=e.stream;e.rtpSender.stop();e.rtpSender=null;e.track=null;e.stream=null;var n=this.transceivers.map(function(e){return e.stream});if(n.indexOf(r)===-1&&this.localStreams.indexOf(r)>-1){this.localStreams.splice(this.localStreams.indexOf(r),1)}this._maybeFireNegotiationNeeded()};n.prototype.removeStream=function(e){var r=this;e.getTracks().forEach(function(t){var e=r.getSenders().find(function(e){return e.track===t});if(e){r.removeTrack(e)}})};n.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})};n.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})};n.prototype._createIceGatherer=function(r,e){var n=this;if(e&&r>0){return this.transceivers[0].iceGatherer}else if(this._iceGatherers.length){return this._iceGatherers.shift()}var i=new A.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(i,"state",{value:"new",writable:true});this.transceivers[r].bufferedCandidateEvents=[];this.transceivers[r].bufferCandidates=function(e){var t=!e.candidate||Object.keys(e.candidate).length===0;i.state=t?"completed":"gathering";if(n.transceivers[r].bufferedCandidateEvents!==null){n.transceivers[r].bufferedCandidateEvents.push(e)}};i.addEventListener("localcandidate",this.transceivers[r].bufferCandidates);return i};n.prototype._gather=function(s,c){var l=this;var d=this.transceivers[c].iceGatherer;if(d.onlocalcandidate){return}var e=this.transceivers[c].bufferedCandidateEvents;this.transceivers[c].bufferedCandidateEvents=null;d.removeEventListener("localcandidate",this.transceivers[c].bufferCandidates);d.onlocalcandidate=function(e){if(l.usingBundle&&c>0){return}var t=new Event("icecandidate");t.candidate={sdpMid:s,sdpMLineIndex:c};var r=e.candidate;var n=!r||Object.keys(r).length===0;if(n){if(d.state==="new"||d.state==="gathering"){d.state="completed"}}else{if(d.state==="new"){d.state="gathering"}r.component=1;var i=x.writeCandidate(r);t.candidate=Object.assign(t.candidate,x.parseCandidate(i));t.candidate.candidate=i}var o=x.getMediaSections(l.localDescription.sdp);if(!n){o[t.candidate.sdpMLineIndex]+="a="+t.candidate.candidate+"\r\n"}else{o[t.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n"}l.localDescription.sdp=x.getDescription(l.localDescription.sdp)+o.join("");var a=l.transceivers.every(function(e){return e.iceGatherer&&e.iceGatherer.state==="completed"});if(l.iceGatheringState!=="gathering"){l.iceGatheringState="gathering";l._emitGatheringStateChange()}if(!n){l._dispatchEvent("icecandidate",t)}if(a){l._dispatchEvent("icecandidate",new Event("icecandidate"));l.iceGatheringState="complete";l._emitGatheringStateChange()}};A.setTimeout(function(){e.forEach(function(e){d.onlocalcandidate(e)})},0)};n.prototype._createIceAndDtlsTransports=function(){var e=this;var t=new A.RTCIceTransport(null);t.onicestatechange=function(){e._updateIceConnectionState();e._updateConnectionState()};var r=new A.RTCDtlsTransport(t);r.ondtlsstatechange=function(){e._updateConnectionState()};r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:true});e._updateConnectionState()};return{iceTransport:t,dtlsTransport:r}};n.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;if(t){delete t.onlocalcandidate;delete this.transceivers[e].iceGatherer}var r=this.transceivers[e].iceTransport;if(r){delete r.onicestatechange;delete this.transceivers[e].iceTransport}var n=this.transceivers[e].dtlsTransport;if(n){delete n.ondtlsstatechange;delete n.onerror;delete this.transceivers[e].dtlsTransport}};n.prototype._transceive=function(e,t,r){var n=v(e.localCapabilities,e.remoteCapabilities);if(t&&e.rtpSender){n.encodings=e.sendEncodingParameters;n.rtcp={cname:x.localCName,compound:e.rtcpParameters.compound};if(e.recvEncodingParameters.length){n.rtcp.ssrc=e.recvEncodingParameters[0].ssrc}e.rtpSender.send(n)}if(r&&e.rtpReceiver&&n.codecs.length>0){if(e.kind==="video"&&e.recvEncodingParameters&&N<15019){e.recvEncodingParameters.forEach(function(e){delete e.rtx})}if(e.recvEncodingParameters.length){n.encodings=e.recvEncodingParameters}else{n.encodings=[{}]}n.rtcp={compound:e.rtcpParameters.compound};if(e.rtcpParameters.cname){n.rtcp.cname=e.rtcpParameters.cname}if(e.sendEncodingParameters.length){n.rtcp.ssrc=e.sendEncodingParameters[0].ssrc}e.rtpReceiver.receive(n)}};n.prototype.setLocalDescription=function(e){var f=this;if(["offer","answer"].indexOf(e.type)===-1){return Promise.reject(u("TypeError",'Unsupported type "'+e.type+'"'))}if(!a("setLocalDescription",e.type,f.signalingState)||f._isClosed){return Promise.reject(u("InvalidStateError","Can not set local "+e.type+" in state "+f.signalingState))}var t;var p;if(e.type==="offer"){t=x.splitSections(e.sdp);p=t.shift();t.forEach(function(e,t){var r=x.parseRtpParameters(e);f.transceivers[t].localCapabilities=r});f.transceivers.forEach(function(e,t){f._gather(e.mid,t)})}else if(e.type==="answer"){t=x.splitSections(f.remoteDescription.sdp);p=t.shift();var g=x.matchPrefix(p,"a=ice-lite").length>0;t.forEach(function(e,t){var r=f.transceivers[t];var n=r.iceGatherer;var i=r.iceTransport;var o=r.dtlsTransport;var a=r.localCapabilities;var s=r.remoteCapabilities;var c=x.isRejected(e)&&x.matchPrefix(e,"a=bundle-only").length===0;if(!c&&!r.rejected){var l=x.getIceParameters(e,p);var d=x.getDtlsParameters(e,p);if(g){d.role="server"}if(!f.usingBundle||t===0){f._gather(r.mid,t);if(i.state==="new"){i.start(n,l,g?"controlling":"controlled")}if(o.state==="new"){o.start(d)}}var u=v(a,s);f._transceive(r,u.codecs.length>0,false)}})}f.localDescription={type:e.type,sdp:e.sdp};if(e.type==="offer"){f._updateSignalingState("have-local-offer")}else{f._updateSignalingState("stable")}return Promise.resolve()};n.prototype.setRemoteDescription=function(k){var I=this;if(["offer","answer"].indexOf(k.type)===-1){return Promise.reject(u("TypeError",'Unsupported type "'+k.type+'"'))}if(!a("setRemoteDescription",k.type,I.signalingState)||I._isClosed){return Promise.reject(u("InvalidStateError","Can not set remote "+k.type+" in state "+I.signalingState))}var w={};I.remoteStreams.forEach(function(e){w[e.id]=e});var O=[];var e=x.splitSections(k.sdp);var P=e.shift();var D=x.matchPrefix(P,"a=ice-lite").length>0;var L=x.matchPrefix(P,"a=group:BUNDLE ").length>0;I.usingBundle=L;var t=x.matchPrefix(P,"a=ice-options:")[0];if(t){I.canTrickleIceCandidates=t.substr(14).split(" ").indexOf("trickle")>=0}else{I.canTrickleIceCandidates=false}e.forEach(function(e,t){var r=x.splitLines(e);var n=x.getKind(e);var i=x.isRejected(e)&&x.matchPrefix(e,"a=bundle-only").length===0;var o=r[0].substr(2).split(" ")[2];var a=x.getDirection(e,P);var s=x.parseMsid(e);var c=x.getMid(e)||x.generateIdentifier();if(n==="application"&&o==="DTLS/SCTP"||i){I.transceivers[t]={mid:c,kind:n,rejected:true};return}if(!i&&I.transceivers[t]&&I.transceivers[t].rejected){I.transceivers[t]=I._createTransceiver(n,true)}var l;var d;var u;var f;var p;var g;var v;var m;var _;var b=x.parseRtpParameters(e);var h;var T;if(!i){h=x.getIceParameters(e,P);T=x.getDtlsParameters(e,P);T.role="client"}v=x.parseRtpEncodingParameters(e);var C=x.parseRtcpParameters(e);var R=x.matchPrefix(e,"a=end-of-candidates",P).length>0;var S=x.matchPrefix(e,"a=candidate:").map(function(e){return x.parseCandidate(e)}).filter(function(e){return e.component===1});if((k.type==="offer"||k.type==="answer")&&!i&&L&&t>0&&I.transceivers[t]){I._disposeIceAndDtlsTransports(t);I.transceivers[t].iceGatherer=I.transceivers[0].iceGatherer;I.transceivers[t].iceTransport=I.transceivers[0].iceTransport;I.transceivers[t].dtlsTransport=I.transceivers[0].dtlsTransport;if(I.transceivers[t].rtpSender){I.transceivers[t].rtpSender.setTransport(I.transceivers[0].dtlsTransport)}if(I.transceivers[t].rtpReceiver){I.transceivers[t].rtpReceiver.setTransport(I.transceivers[0].dtlsTransport)}}if(k.type==="offer"&&!i){l=I.transceivers[t]||I._createTransceiver(n);l.mid=c;if(!l.iceGatherer){l.iceGatherer=I._createIceGatherer(t,L)}if(S.length&&l.iceTransport.state==="new"){if(R&&(!L||t===0)){l.iceTransport.setRemoteCandidates(S)}else{S.forEach(function(e){U(l.iceTransport,e)})}}m=A.RTCRtpReceiver.getCapabilities(n);if(N<15019){m.codecs=m.codecs.filter(function(e){return e.name!=="rtx"})}g=l.sendEncodingParameters||[{ssrc:(2*t+2)*1001}];var E=false;if(a==="sendrecv"||a==="sendonly"){E=!l.rtpReceiver;p=l.rtpReceiver||new A.RTCRtpReceiver(l.dtlsTransport,n);if(E){var y;_=p.track;if(s&&s.stream==="-"){}else if(s){if(!w[s.stream]){w[s.stream]=new A.MediaStream;Object.defineProperty(w[s.stream],"id",{get:function(){return s.stream}})}Object.defineProperty(_,"id",{get:function(){return s.track}});y=w[s.stream]}else{if(!w.default){w.default=new A.MediaStream}y=w.default}if(y){W(_,y);l.associatedRemoteMediaStreams.push(y)}O.push([_,p,y])}}else if(l.rtpReceiver&&l.rtpReceiver.track){l.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===l.rtpReceiver.track.id});if(t){M(t,e)}});l.associatedRemoteMediaStreams=[]}l.localCapabilities=m;l.remoteCapabilities=b;l.rtpReceiver=p;l.rtcpParameters=C;l.sendEncodingParameters=g;l.recvEncodingParameters=v;I._transceive(I.transceivers[t],false,E)}else if(k.type==="answer"&&!i){l=I.transceivers[t];d=l.iceGatherer;u=l.iceTransport;f=l.dtlsTransport;p=l.rtpReceiver;g=l.sendEncodingParameters;m=l.localCapabilities;I.transceivers[t].recvEncodingParameters=v;I.transceivers[t].remoteCapabilities=b;I.transceivers[t].rtcpParameters=C;if(S.length&&u.state==="new"){if((D||R)&&(!L||t===0)){u.setRemoteCandidates(S)}else{S.forEach(function(e){U(l.iceTransport,e)})}}if(!L||t===0){if(u.state==="new"){u.start(d,h,"controlling")}if(f.state==="new"){f.start(T)}}I._transceive(l,a==="sendrecv"||a==="recvonly",a==="sendrecv"||a==="sendonly");if(p&&(a==="sendrecv"||a==="sendonly")){_=p.track;if(s){if(!w[s.stream]){w[s.stream]=new A.MediaStream}W(_,w[s.stream]);O.push([_,p,w[s.stream]])}else{if(!w.default){w.default=new A.MediaStream}W(_,w.default);O.push([_,p,w.default])}}else{delete l.rtpReceiver}}});if(I._dtlsRole===undefined){I._dtlsRole=k.type==="offer"?"active":"passive"}I.remoteDescription={type:k.type,sdp:k.sdp};if(k.type==="offer"){I._updateSignalingState("have-remote-offer")}else{I._updateSignalingState("stable")}Object.keys(w).forEach(function(e){var n=w[e];if(n.getTracks().length){if(I.remoteStreams.indexOf(n)===-1){I.remoteStreams.push(n);var t=new Event("addstream");t.stream=n;A.setTimeout(function(){I._dispatchEvent("addstream",t)})}O.forEach(function(e){var t=e[0];var r=e[1];if(n.id!==e[2].id){return}i(I,t,r,[n])})}});O.forEach(function(e){if(e[2]){return}i(I,e[0],e[1],[])});A.setTimeout(function(){if(!(I&&I.transceivers)){return}I.transceivers.forEach(function(e){if(e.iceTransport&&e.iceTransport.state==="new"&&e.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");e.iceTransport.addRemoteCandidate({})}})},4e3);return Promise.resolve()};n.prototype.close=function(){this.transceivers.forEach(function(e){if(e.iceTransport){e.iceTransport.stop()}if(e.dtlsTransport){e.dtlsTransport.stop()}if(e.rtpSender){e.rtpSender.stop()}if(e.rtpReceiver){e.rtpReceiver.stop()}});this._isClosed=true;this._updateSignalingState("closed")};n.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)};n.prototype._maybeFireNegotiationNeeded=function(){var t=this;if(this.signalingState!=="stable"||this.needNegotiation===true){return}this.needNegotiation=true;A.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=false;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0)};n.prototype._updateIceConnectionState=function(){var e;var t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){t[e.iceTransport.state]++});e="new";if(t.failed>0){e="failed"}else if(t.checking>0){e="checking"}else if(t.disconnected>0){e="disconnected"}else if(t.new>0){e="new"}else if(t.connected>0){e="connected"}else if(t.completed>0){e="completed"}if(e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}};n.prototype._updateConnectionState=function(){var e;var t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){t[e.iceTransport.state]++;t[e.dtlsTransport.state]++});t.connected+=t.completed;e="new";if(t.failed>0){e="failed"}else if(t.connecting>0){e="connecting"}else if(t.disconnected>0){e="disconnected"}else if(t.new>0){e="new"}else if(t.connected>0){e="connected"}if(e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}};n.prototype.createOffer=function(){var s=this;if(s._isClosed){return Promise.reject(u("InvalidStateError","Can not call createOffer after close"))}var t=s.transceivers.filter(function(e){return e.kind==="audio"}).length;var r=s.transceivers.filter(function(e){return e.kind==="video"}).length;var e=arguments[0];if(e){if(e.mandatory||e.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(e.offerToReceiveAudio!==undefined){if(e.offerToReceiveAudio===true){t=1}else if(e.offerToReceiveAudio===false){t=0}else{t=e.offerToReceiveAudio}}if(e.offerToReceiveVideo!==undefined){if(e.offerToReceiveVideo===true){r=1}else if(e.offerToReceiveVideo===false){r=0}else{r=e.offerToReceiveVideo}}}s.transceivers.forEach(function(e){if(e.kind==="audio"){t--;if(t<0){e.wantReceive=false}}else if(e.kind==="video"){r--;if(r<0){e.wantReceive=false}}});while(t>0||r>0){if(t>0){s._createTransceiver("audio");t--}if(r>0){s._createTransceiver("video");r--}}var n=x.writeSessionBoilerplate(s._sdpSessionId,s._sdpSessionVersion++);s.transceivers.forEach(function(r,e){var t=r.track;var n=r.kind;var i=r.mid||x.generateIdentifier();r.mid=i;if(!r.iceGatherer){r.iceGatherer=s._createIceGatherer(e,s.usingBundle)}var o=A.RTCRtpSender.getCapabilities(n);if(N<15019){o.codecs=o.codecs.filter(function(e){return e.name!=="rtx"})}o.codecs.forEach(function(t){if(t.name==="H264"&&t.parameters["level-asymmetry-allowed"]===undefined){t.parameters["level-asymmetry-allowed"]="1"}if(r.remoteCapabilities&&r.remoteCapabilities.codecs){r.remoteCapabilities.codecs.forEach(function(e){if(t.name.toLowerCase()===e.name.toLowerCase()&&t.clockRate===e.clockRate){t.preferredPayloadType=e.payloadType}})}});o.headerExtensions.forEach(function(t){var e=r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[];e.forEach(function(e){if(t.uri===e.uri){t.id=e.id}})});var a=r.sendEncodingParameters||[{ssrc:(2*e+1)*1001}];if(t){if(N>=15019&&n==="video"&&!a[0].rtx){a[0].rtx={ssrc:a[0].ssrc+1}}}if(r.wantReceive){r.rtpReceiver=new A.RTCRtpReceiver(r.dtlsTransport,n)}r.localCapabilities=o;r.sendEncodingParameters=a});if(s._config.bundlePolicy!=="max-compat"){n+="a=group:BUNDLE "+s.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"}n+="a=ice-options:trickle\r\n";s.transceivers.forEach(function(e,t){n+=c(e,e.localCapabilities,"offer",e.stream,s._dtlsRole);n+="a=rtcp-rsize\r\n";if(e.iceGatherer&&s.iceGatheringState!=="new"&&(t===0||!s.usingBundle)){e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1;n+="a="+x.writeCandidate(e)+"\r\n"});if(e.iceGatherer.state==="completed"){n+="a=end-of-candidates\r\n"}}});var i=new A.RTCSessionDescription({type:"offer",sdp:n});return Promise.resolve(i)};n.prototype.createAnswer=function(){var o=this;if(o._isClosed){return Promise.reject(u("InvalidStateError","Can not call createAnswer after close"))}if(!(o.signalingState==="have-remote-offer"||o.signalingState==="have-local-pranswer")){return Promise.reject(u("InvalidStateError","Can not call createAnswer in signalingState "+o.signalingState))}var a=x.writeSessionBoilerplate(o._sdpSessionId,o._sdpSessionVersion++);if(o.usingBundle){a+="a=group:BUNDLE "+o.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"}var s=x.getMediaSections(o.remoteDescription.sdp).length;o.transceivers.forEach(function(e,t){if(t+1>s){return}if(e.rejected){if(e.kind==="application"){a+="m=application 0 DTLS/SCTP 5000\r\n"}else if(e.kind==="audio"){a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\n"+"a=rtpmap:0 PCMU/8000\r\n"}else if(e.kind==="video"){a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\n"+"a=rtpmap:120 VP8/90000\r\n"}a+="c=IN IP4 0.0.0.0\r\n"+"a=inactive\r\n"+"a=mid:"+e.mid+"\r\n";return}if(e.stream){var r;if(e.kind==="audio"){r=e.stream.getAudioTracks()[0]}else if(e.kind==="video"){r=e.stream.getVideoTracks()[0]}if(r){if(N>=15019&&e.kind==="video"&&!e.sendEncodingParameters[0].rtx){e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}}}}var n=v(e.localCapabilities,e.remoteCapabilities);var i=n.codecs.filter(function(e){return e.name.toLowerCase()==="rtx"}).length;if(!i&&e.sendEncodingParameters[0].rtx){delete e.sendEncodingParameters[0].rtx}a+=c(e,n,"answer",e.stream,o._dtlsRole);if(e.rtcpParameters&&e.rtcpParameters.reducedSize){a+="a=rtcp-rsize\r\n"}});var e=new A.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(e)};n.prototype.addIceCandidate=function(c){var l=this;var d;if(c&&!(c.sdpMLineIndex!==undefined||c.sdpMid)){return Promise.reject(new TypeError("sdpMLineIndex or sdpMid required"))}return new Promise(function(e,t){if(!l.remoteDescription){return t(u("InvalidStateError","Can not add ICE candidate without a remote description"))}else if(!c||c.candidate===""){for(var r=0;r<l.transceivers.length;r++){if(l.transceivers[r].rejected){continue}l.transceivers[r].iceTransport.addRemoteCandidate({});d=x.getMediaSections(l.remoteDescription.sdp);d[r]+="a=end-of-candidates\r\n";l.remoteDescription.sdp=x.getDescription(l.remoteDescription.sdp)+d.join("");if(l.usingBundle){break}}}else{var n=c.sdpMLineIndex;if(c.sdpMid){for(var i=0;i<l.transceivers.length;i++){if(l.transceivers[i].mid===c.sdpMid){n=i;break}}}var o=l.transceivers[n];if(o){if(o.rejected){return e()}var a=Object.keys(c.candidate).length>0?x.parseCandidate(c.candidate):{};if(a.protocol==="tcp"&&(a.port===0||a.port===9)){return e()}if(a.component&&a.component!==1){return e()}if(n===0||n>0&&o.iceTransport!==l.transceivers[0].iceTransport){if(!U(o.iceTransport,a)){return t(u("OperationError","Can not add ICE candidate"))}}var s=c.candidate.trim();if(s.indexOf("a=")===0){s=s.substr(2)}d=x.getMediaSections(l.remoteDescription.sdp);d[n]+="a="+(a.type?s:"end-of-candidates")+"\r\n";l.remoteDescription.sdp=d.join("")}else{return t(u("OperationError","Can not add ICE candidate"))}}e()})};n.prototype.getStats=function(){var n=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(e){if(t[e]){n.push(t[e].getStats())}})});var i=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};return new Promise(function(t){var r=new Map;Promise.all(n).then(function(e){e.forEach(function(t){Object.keys(t).forEach(function(e){t[e].type=i(t[e]);r.set(e,t[e])})});t(r)})})};var e=["createOffer","createAnswer"];e.forEach(function(e){var r=n.prototype[e];n.prototype[e]=function(){var t=arguments;if(typeof t[0]==="function"||typeof t[1]==="function"){return r.apply(this,[arguments[2]]).then(function(e){if(typeof t[0]==="function"){t[0].apply(null,[e])}},function(e){if(typeof t[1]==="function"){t[1].apply(null,[e])}})}return r.apply(this,arguments)}});e=["setLocalDescription","setRemoteDescription","addIceCandidate"];e.forEach(function(e){var r=n.prototype[e];n.prototype[e]=function(){var t=arguments;if(typeof t[1]==="function"||typeof t[2]==="function"){return r.apply(this,arguments).then(function(){if(typeof t[1]==="function"){t[1].apply(null)}},function(e){if(typeof t[2]==="function"){t[2].apply(null,[e])}})}return r.apply(this,arguments)}});["getStats"].forEach(function(e){var t=n.prototype[e];n.prototype[e]=function(){var e=arguments;if(typeof e[1]==="function"){return t.apply(this,arguments).then(function(){if(typeof e[1]==="function"){e[1].apply(null)}})}return t.apply(this,arguments)}});return n}},{sdp:1}],3:[function(e,t,r){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};d.localCName=d.generateIdentifier();d.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})};d.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})};d.getDescription=function(e){var t=d.splitSections(e);return t&&t[0]};d.getMediaSections=function(e){var t=d.splitSections(e);t.shift();return t};d.matchPrefix=function(e,t){return d.splitLines(e).filter(function(e){return e.indexOf(t)===0})};d.parseCandidate=function(e){var t;if(e.indexOf("a=candidate:")===0){t=e.substring(12).split(" ")}else{t=e.substring(10).split(" ")}var r={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]};for(var n=8;n<t.length;n+=2){switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1];r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];break}}return r};d.writeCandidate=function(e){var t=[];t.push(e.foundation);t.push(e.component);t.push(e.protocol.toUpperCase());t.push(e.priority);t.push(e.ip);t.push(e.port);var r=e.type;t.push("typ");t.push(r);if(r!=="host"&&e.relatedAddress&&e.relatedPort){t.push("raddr");t.push(e.relatedAddress);t.push("rport");t.push(e.relatedPort)}if(e.tcpType&&e.protocol.toLowerCase()==="tcp"){t.push("tcptype");t.push(e.tcpType)}if(e.usernameFragment||e.ufrag){t.push("ufrag");t.push(e.usernameFragment||e.ufrag)}return"candidate:"+t.join(" ")};d.parseIceOptions=function(e){return e.substr(14).split(" ")};d.parseRtpMap=function(e){var t=e.substr(9).split(" ");var r={payloadType:parseInt(t.shift(),10)};t=t[0].split("/");r.name=t[0];r.clockRate=parseInt(t[1],10);r.numChannels=t.length===3?parseInt(t[2],10):1;return r};d.writeRtpMap=function(e){var t=e.payloadType;if(e.preferredPayloadType!==undefined){t=e.preferredPayloadType}return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(e.numChannels!==1?"/"+e.numChannels:"")+"\r\n"};d.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}};d.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+"\r\n"};d.parseFmtp=function(e){var t={};var r;var n=e.substr(e.indexOf(" ")+1).split(";");for(var i=0;i<n.length;i++){r=n[i].trim().split("=");t[r[0].trim()]=r[1]}return t};d.writeFmtp=function(t){var e="";var r=t.payloadType;if(t.preferredPayloadType!==undefined){r=t.preferredPayloadType}if(t.parameters&&Object.keys(t.parameters).length){var n=[];Object.keys(t.parameters).forEach(function(e){n.push(e+"="+t.parameters[e])});e+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return e};d.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};d.writeRtcpFb=function(e){var t="";var r=e.payloadType;if(e.preferredPayloadType!==undefined){r=e.preferredPayloadType}if(e.rtcpFeedback&&e.rtcpFeedback.length){e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})}return t};d.parseSsrcMedia=function(e){var t=e.indexOf(" ");var r={ssrc:parseInt(e.substr(7,t-7),10)};var n=e.indexOf(":",t);if(n>-1){r.attribute=e.substr(t+1,n-t-1);r.value=e.substr(n+1)}else{r.attribute=e.substr(t+1)}return r};d.getMid=function(e){var t=d.matchPrefix(e,"a=mid:")[0];if(t){return t.substr(6)}};d.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}};d.getDtlsParameters=function(e,t){var r=d.matchPrefix(e+t,"a=fingerprint:");return{role:"auto",fingerprints:r.map(d.parseFingerprint)}};d.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"});return r};d.getIceParameters=function(e,t){var r=d.splitLines(e);r=r.concat(d.splitLines(t));var n={usernameFragment:r.filter(function(e){return e.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:r.filter(function(e){return e.indexOf("a=ice-pwd:")===0})[0].substr(10)};return n};d.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\n"+"a=ice-pwd:"+e.password+"\r\n"};d.parseRtpParameters=function(e){var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var r=d.splitLines(e);var n=r[0].split(" ");for(var i=3;i<n.length;i++){var o=n[i];var a=d.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=d.parseRtpMap(a);var c=d.matchPrefix(e,"a=fmtp:"+o+" ");s.parameters=c.length?d.parseFmtp(c[0]):{};s.rtcpFeedback=d.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(d.parseRtcpFb);t.codecs.push(s);switch(s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase());break;default:break}}}d.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(d.parseExtmap(e))});return t};d.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ";r+=t.codecs.length>0?"9":"0";r+=" UDP/TLS/RTP/SAVPF ";r+=t.codecs.map(function(e){if(e.preferredPayloadType!==undefined){return e.preferredPayloadType}return e.payloadType}).join(" ")+"\r\n";r+="c=IN IP4 0.0.0.0\r\n";r+="a=rtcp:9 IN IP4 0.0.0.0\r\n";t.codecs.forEach(function(e){r+=d.writeRtpMap(e);r+=d.writeFmtp(e);r+=d.writeRtcpFb(e)});var n=0;t.codecs.forEach(function(e){if(e.maxptime>n){n=e.maxptime}});if(n>0){r+="a=maxptime:"+n+"\r\n"}r+="a=rtcp-mux\r\n";t.headerExtensions.forEach(function(e){r+=d.writeExtmap(e)});return r};d.parseRtpEncodingParameters=function(e){var r=[];var t=d.parseRtpParameters(e);var n=t.fecMechanisms.indexOf("RED")!==-1;var i=t.fecMechanisms.indexOf("ULPFEC")!==-1;var o=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"});var a=o.length>0&&o[0].ssrc;var s;var c=d.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");t.shift();return t.map(function(e){return parseInt(e,10)})});if(c.length>0&&c[0].length>1&&c[0][0]===a){s=c[0][1]}t.codecs.forEach(function(e){if(e.name.toUpperCase()==="RTX"&&e.parameters.apt){var t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{ssrc:s}};r.push(t);if(n){t=JSON.parse(JSON.stringify(t));t.fec={ssrc:s,mechanism:i?"red+ulpfec":"red"};r.push(t)}}});if(r.length===0&&a){r.push({ssrc:a})}var l=d.matchPrefix(e,"b=");if(l.length){if(l[0].indexOf("b=TIAS:")===0){l=parseInt(l[0].substr(7),10)}else if(l[0].indexOf("b=AS:")===0){l=parseInt(l[0].substr(5),10)*1e3*.95-50*40*8}else{l=undefined}r.forEach(function(e){e.maxBitrate=l})}return r};d.parseRtcpParameters=function(e){var t={};var r;var n=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"})[0];if(n){t.cname=n.value;t.ssrc=n.ssrc}var i=d.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0;t.compound=i.length===0;var o=d.matchPrefix(e,"a=rtcp-mux");t.mux=o.length>0;return t};d.parseMsid=function(e){var t;var r=d.matchPrefix(e,"a=msid:");if(r.length===1){t=r[0].substr(7).split(" ");return{stream:t[0],track:t[1]}}var n=d.matchPrefix(e,"a=ssrc:").map(function(e){return d.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="msid"});if(n.length>0){t=n[0].value.split(" ");return{stream:t[0],track:t[1]}}};d.generateSessionId=function(){return Math.random().toString().substr(2,21)};d.writeSessionBoilerplate=function(e,t){var r;var n=t!==undefined?t:2;if(e){r=e}else{r=d.generateSessionId()}return"v=0\r\n"+"o=thisisadapterortc "+r+" "+n+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};d.writeMediaSection=function(e,t,r,n){var i=d.writeRtpDescription(e.kind,t);i+=d.writeIceParameters(e.iceGatherer.getLocalParameters());i+=d.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),r==="offer"?"actpass":"active");i+="a=mid:"+e.mid+"\r\n";if(e.direction){i+="a="+e.direction+"\r\n"}else if(e.rtpSender&&e.rtpReceiver){i+="a=sendrecv\r\n"}else if(e.rtpSender){i+="a=sendonly\r\n"}else if(e.rtpReceiver){i+="a=recvonly\r\n"}else{i+="a=inactive\r\n"}if(e.rtpSender){var o="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o;i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o;if(e.sendEncodingParameters[0].rtx){i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o;i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n";if(e.rtpSender&&e.sendEncodingParameters[0].rtx){i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"}return i};d.getDirection=function(e,t){var r=d.splitLines(e);for(var n=0;n<r.length;n++){switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2);default:}}if(t){return d.getDirection(t)}return"sendrecv"};d.getKind=function(e){var t=d.splitLines(e);var r=t[0].split(" ");return r[0].substr(2)};d.isRejected=function(e){return e.split(" ",2)[1]==="0"};d.parseMLine=function(e){var t=d.splitLines(e);var r=t[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}};d.parseOLine=function(e){var t=d.matchPrefix(e,"o=")[0];var r=t.substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}};if(typeof t==="object"){t.exports=d}},{}],4:[function(r,n,e){(function(e){"use strict";var t=r("./adapter_factory.js");n.exports=t({window:e.window})}).call(this,typeof i!=="undefined"?i:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./adapter_factory.js":5}],5:[function(p,e,t){"use strict";var g=p("./utils");e.exports=function(e,t){var r=e&&e.window;var n={shimChrome:true,shimFirefox:true,shimEdge:true,shimSafari:true};for(var i in t){if(hasOwnProperty.call(t,i)){n[i]=t[i]}}var o=g.log;var a=g.detectBrowser(r);var s=p("./chrome/chrome_shim")||null;var c=p("./edge/edge_shim")||null;var l=p("./firefox/firefox_shim")||null;var d=p("./safari/safari_shim")||null;var u=p("./common_shim")||null;var f={browserDetails:a,commonShim:u,extractVersion:g.extractVersion,disableLog:g.disableLog,disableWarnings:g.disableWarnings};switch(a.browser){case"chrome":if(!s||!s.shimPeerConnection||!n.shimChrome){o("Chrome shim is not included in this adapter release.");return f}o("adapter.js shimming chrome.");f.browserShim=s;u.shimCreateObjectURL(r);s.shimGetUserMedia(r);s.shimMediaStream(r);s.shimSourceObject(r);s.shimPeerConnection(r);s.shimOnTrack(r);s.shimAddTrackRemoveTrack(r);s.shimGetSendersWithDtmf(r);u.shimRTCIceCandidate(r);u.shimMaxMessageSize(r);u.shimSendThrowTypeError(r);break;case"firefox":if(!l||!l.shimPeerConnection||!n.shimFirefox){o("Firefox shim is not included in this adapter release.");return f}o("adapter.js shimming firefox.");f.browserShim=l;u.shimCreateObjectURL(r);l.shimGetUserMedia(r);l.shimSourceObject(r);l.shimPeerConnection(r);l.shimOnTrack(r);l.shimRemoveStream(r);u.shimRTCIceCandidate(r);u.shimMaxMessageSize(r);u.shimSendThrowTypeError(r);break;case"edge":if(!c||!c.shimPeerConnection||!n.shimEdge){o("MS edge shim is not included in this adapter release.");return f}o("adapter.js shimming edge.");f.browserShim=c;u.shimCreateObjectURL(r);c.shimGetUserMedia(r);c.shimPeerConnection(r);c.shimReplaceTrack(r);u.shimMaxMessageSize(r);u.shimSendThrowTypeError(r);break;case"safari":if(!d||!n.shimSafari){o("Safari shim is not included in this adapter release.");return f}o("adapter.js shimming safari.");f.browserShim=d;u.shimCreateObjectURL(r);d.shimRTCIceServerUrls(r);d.shimCallbacksAPI(r);d.shimLocalStreamsAPI(r);d.shimRemoteStreamsAPI(r);d.shimTrackEventTransceiver(r);d.shimGetUserMedia(r);d.shimCreateOfferLegacy(r);u.shimRTCIceCandidate(r);u.shimMaxMessageSize(r);u.shimSendThrowTypeError(r);break;default:o("Unsupported browser!");break}return f}},{"./chrome/chrome_shim":6,"./common_shim":8,"./edge/edge_shim":9,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],6:[function(e,t,r){"use strict";var l=e("../utils.js");var n=l.log;t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(o){if(typeof o==="object"&&o.RTCPeerConnection&&!("ontrack"in o.RTCPeerConnection.prototype)){Object.defineProperty(o.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){if(this._ontrack){this.removeEventListener("track",this._ontrack)}this.addEventListener("track",this._ontrack=e)}});var e=o.RTCPeerConnection.prototype.setRemoteDescription;o.RTCPeerConnection.prototype.setRemoteDescription=function(){var i=this;if(!i._ontrackpoly){i._ontrackpoly=function(n){n.stream.addEventListener("addtrack",function(t){var e;if(o.RTCPeerConnection.prototype.getReceivers){e=i.getReceivers().find(function(e){return e.track&&e.track.id===t.track.id})}else{e={track:t.track}}var r=new Event("track");r.track=t.track;r.receiver=e;r.transceiver={receiver:e};r.streams=[n.stream];i.dispatchEvent(r)});n.stream.getTracks().forEach(function(t){var e;if(o.RTCPeerConnection.prototype.getReceivers){e=i.getReceivers().find(function(e){return e.track&&e.track.id===t.id})}else{e={track:t}}var r=new Event("track");r.track=t;r.receiver=e;r.transceiver={receiver:e};r.streams=[n.stream];i.dispatchEvent(r)})};i.addEventListener("addstream",i._ontrackpoly)}return e.apply(i,arguments)}}else if(!("RTCRtpTransceiver"in o)){l.wrapPeerConnectionEvent(o,"track",function(e){if(!e.transceiver){e.transceiver={receiver:e.receiver}}return e})}},shimGetSendersWithDtmf:function(e){if(typeof e==="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var i=function(e,t){return{track:t,get dtmf(){if(this._dtmf===undefined){if(t.kind==="audio"){this._dtmf=e.createDTMFSender(t)}else{this._dtmf=null}}return this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){this._senders=this._senders||[];return this._senders.slice()};var o=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,t){var r=this;var n=o.apply(r,arguments);if(!n){n=i(r,e);r._senders.push(n)}return n};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;n.apply(t,arguments);var r=t._senders.indexOf(e);if(r!==-1){t._senders.splice(r,1)}}}var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;t._senders=t._senders||[];r.apply(t,[e]);e.getTracks().forEach(function(e){t._senders.push(i(t,e))})};var t=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var r=this;r._senders=r._senders||[];t.apply(r,[e]);e.getTracks().forEach(function(t){var e=r._senders.find(function(e){return e.track===t});if(e){r._senders.splice(r._senders.indexOf(e),1)}})}}else if(typeof e==="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var t=this;var e=a.apply(t,[]);e.forEach(function(e){e._pc=t});return e};Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=this._pc.createDTMFSender(this.track)}else{this._dtmf=null}}return this._dtmf}})}},shimSourceObject:function(e){var r=e&&e.URL;if(typeof e==="object"){if(e.HTMLMediaElement&&!("srcObject"in e.HTMLMediaElement.prototype)){Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;this._srcObject=e;if(this.src){r.revokeObjectURL(this.src)}if(!e){this.src="";return undefined}this.src=r.createObjectURL(e);e.addEventListener("addtrack",function(){if(t.src){r.revokeObjectURL(t.src)}t.src=r.createObjectURL(e)});e.addEventListener("removetrack",function(){if(t.src){r.revokeObjectURL(t.src)}t.src=r.createObjectURL(e)})}})}}},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map(function(e){return t._shimmedLocalStreams[e][0]})};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,t){if(!t){return n.apply(this,arguments)}this._shimmedLocalStreams=this._shimmedLocalStreams||{};var r=n.apply(this,arguments);if(!this._shimmedLocalStreams[t.id]){this._shimmedLocalStreams[t.id]=[t,r]}else if(this._shimmedLocalStreams[t.id].indexOf(r)===-1){this._shimmedLocalStreams[t.id].push(r)}return r};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};e.getTracks().forEach(function(t){var e=r.getSenders().find(function(e){return e.track===t});if(e){throw new DOMException("Track already exists.","InvalidAccessError")}});var t=r.getSenders();i.apply(this,arguments);var n=r.getSenders().filter(function(e){return t.indexOf(e)===-1});this._shimmedLocalStreams[e.id]=[e].concat(n)};var t=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[e.id];return t.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(r){var n=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};if(r){Object.keys(this._shimmedLocalStreams).forEach(function(e){var t=n._shimmedLocalStreams[e].indexOf(r);if(t!==-1){n._shimmedLocalStreams[e].splice(t,1)}if(n._shimmedLocalStreams[e].length===1){delete n._shimmedLocalStreams[e]}})}return o.apply(this,arguments)}},shimAddTrackRemoveTrack:function(s){var e=l.detectBrowser(s);if(s.RTCPeerConnection.prototype.addTrack&&e.version>=65){return this.shimAddTrackRemoveTrackWithNative(s)}var r=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this;var e=r.apply(this);t._reverseStreams=t._reverseStreams||{};return e.map(function(e){return t._reverseStreams[e.id]})};var n=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(e){var r=this;r._streams=r._streams||{};r._reverseStreams=r._reverseStreams||{};e.getTracks().forEach(function(t){var e=r.getSenders().find(function(e){return e.track===t});if(e){throw new DOMException("Track already exists.","InvalidAccessError")}});if(!r._reverseStreams[e.id]){var t=new s.MediaStream(e.getTracks());r._streams[e.id]=t;r._reverseStreams[t.id]=e;e=t}n.apply(r,[e])};var i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{};t._reverseStreams=t._reverseStreams||{};i.apply(t,[t._streams[e.id]||e]);delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id];delete t._streams[e.id]};s.RTCPeerConnection.prototype.addTrack=function(t,e){var r=this;if(r.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}var n=[].slice.call(arguments,1);if(n.length!==1||!n[0].getTracks().find(function(e){return e===t})){throw new DOMException("The adapter.js addTrack polyfill only supports a single "+" stream which is associated with the specified track.","NotSupportedError")}var i=r.getSenders().find(function(e){return e.track===t});if(i){throw new DOMException("Track already exists.","InvalidAccessError")}r._streams=r._streams||{};r._reverseStreams=r._reverseStreams||{};var o=r._streams[e.id];if(o){o.addTrack(t);Promise.resolve().then(function(){r.dispatchEvent(new Event("negotiationneeded"))})}else{var a=new s.MediaStream([t]);r._streams[e.id]=a;r._reverseStreams[a.id]=e;r.addStream(a)}return r.getSenders().find(function(e){return e.track===t})};function o(n,e){var i=e.sdp;Object.keys(n._reverseStreams||[]).forEach(function(e){var t=n._reverseStreams[e];var r=n._streams[t.id];i=i.replace(new RegExp(r.id,"g"),t.id)});return new RTCSessionDescription({type:e.type,sdp:i})}function t(n,e){var i=e.sdp;Object.keys(n._reverseStreams||[]).forEach(function(e){var t=n._reverseStreams[e];var r=n._streams[t.id];i=i.replace(new RegExp(t.id,"g"),r.id)});return new RTCSessionDescription({type:e.type,sdp:i})}["createOffer","createAnswer"].forEach(function(e){var t=s.RTCPeerConnection.prototype[e];s.RTCPeerConnection.prototype[e]=function(){var r=this;var n=arguments;var e=arguments.length&&typeof arguments[0]==="function";if(e){return t.apply(r,[function(e){var t=o(r,e);n[0].apply(null,[t])},function(e){if(n[1]){n[1].apply(null,e)}},arguments[2]])}return t.apply(r,arguments).then(function(e){return o(r,e)})}});var a=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;if(!arguments.length||!arguments[0].type){return a.apply(e,arguments)}arguments[0]=t(e,arguments[0]);return a.apply(e,arguments)};var c=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=this;var t=c.get.apply(this);if(t.type===""){return t}return o(e,t)}});s.RTCPeerConnection.prototype.removeTrack=function(r){var n=this;if(n.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}if(!r._pc){throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.","TypeError")}var e=r._pc===n;if(!e){throw new DOMException("Sender was not created by this connection.","InvalidAccessError")}n._streams=n._streams||{};var i;Object.keys(n._streams).forEach(function(e){var t=n._streams[e].getTracks().find(function(e){return r.track===e});if(t){i=n._streams[e]}});if(i){if(i.getTracks().length===1){n.removeStream(n._reverseStreams[i.id])}else{i.removeTrack(r.track)}n.dispatchEvent(new Event("negotiationneeded"))}}},shimPeerConnection:function(r){var e=l.detectBrowser(r);if(!r.RTCPeerConnection&&r.webkitRTCPeerConnection){r.RTCPeerConnection=function(e,t){n("PeerConnection");if(e&&e.iceTransportPolicy){e.iceTransports=e.iceTransportPolicy}return new r.webkitRTCPeerConnection(e,t)};r.RTCPeerConnection.prototype=r.webkitRTCPeerConnection.prototype;if(r.webkitRTCPeerConnection.generateCertificate){Object.defineProperty(r.RTCPeerConnection,"generateCertificate",{get:function(){return r.webkitRTCPeerConnection.generateCertificate}})}}else{var o=r.RTCPeerConnection;r.RTCPeerConnection=function(e,t){if(e&&e.iceServers){var r=[];for(var n=0;n<e.iceServers.length;n++){var i=e.iceServers[n];if(!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")){l.deprecated("RTCIceServer.url","RTCIceServer.urls");i=JSON.parse(JSON.stringify(i));i.urls=i.url;r.push(i)}else{r.push(e.iceServers[n])}}e.iceServers=r}return new o(e,t)};r.RTCPeerConnection.prototype=o.prototype;Object.defineProperty(r.RTCPeerConnection,"generateCertificate",{get:function(){return o.generateCertificate}})}var c=r.RTCPeerConnection.prototype.getStats;r.RTCPeerConnection.prototype.getStats=function(e,t,r){var n=this;var i=arguments;if(arguments.length>0&&typeof e==="function"){return c.apply(this,arguments)}if(c.length===0&&(arguments.length===0||typeof arguments[0]!=="function")){return c.apply(this,[])}var o=function(e){var n={};var t=e.result();t.forEach(function(t){var r={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach(function(e){r[e]=t.stat(e)});n[r.id]=r});return n};var a=function(t){return new Map(Object.keys(t).map(function(e){return[e,t[e]]}))};if(arguments.length>=2){var s=function(e){i[1](a(o(e)))};return c.apply(this,[s,arguments[0]])}return new Promise(function(t,e){c.apply(n,[function(e){t(a(o(e)))},e])}).then(t,r)};if(e.version<51){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var i=r.RTCPeerConnection.prototype[e];r.RTCPeerConnection.prototype[e]=function(){var r=arguments;var n=this;var e=new Promise(function(e,t){i.apply(n,[r[0],e,t])});if(r.length<2){return e}return e.then(function(){r[1].apply(null,[])},function(e){if(r.length>=3){r[2].apply(null,[e])}})}})}if(e.version<52){["createOffer","createAnswer"].forEach(function(e){var i=r.RTCPeerConnection.prototype[e];r.RTCPeerConnection.prototype[e]=function(){var r=this;if(arguments.length<1||arguments.length===1&&typeof arguments[0]==="object"){var n=arguments.length===1?arguments[0]:undefined;return new Promise(function(e,t){i.apply(r,[e,t,n])})}return i.apply(this,arguments)}})}["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=r.RTCPeerConnection.prototype[e];r.RTCPeerConnection.prototype[e]=function(){arguments[0]=new(e==="addIceCandidate"?r.RTCIceCandidate:r.RTCSessionDescription)(arguments[0]);return t.apply(this,arguments)}});var t=r.RTCPeerConnection.prototype.addIceCandidate;r.RTCPeerConnection.prototype.addIceCandidate=function(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}return t.apply(this,arguments)}}}},{"../utils.js":14,"./getusermedia":7}],7:[function(e,t,r){"use strict";var l=e("../utils.js");var d=l.log;t.exports=function(e){var a=l.detectBrowser(e);var s=e&&e.navigator;var c=function(i){if(typeof i!=="object"||i.mandatory||i.optional){return i}var o={};Object.keys(i).forEach(function(t){if(t==="require"||t==="advanced"||t==="mediaSource"){return}var r=typeof i[t]==="object"?i[t]:{ideal:i[t]};if(r.exact!==undefined&&typeof r.exact==="number"){r.min=r.max=r.exact}var n=function(e,t){if(e){return e+t.charAt(0).toUpperCase()+t.slice(1)}return t==="deviceId"?"sourceId":t};if(r.ideal!==undefined){o.optional=o.optional||[];var e={};if(typeof r.ideal==="number"){e[n("min",t)]=r.ideal;o.optional.push(e);e={};e[n("max",t)]=r.ideal;o.optional.push(e)}else{e[n("",t)]=r.ideal;o.optional.push(e)}}if(r.exact!==undefined&&typeof r.exact!=="number"){o.mandatory=o.mandatory||{};o.mandatory[n("",t)]=r.exact}else{["min","max"].forEach(function(e){if(r[e]!==undefined){o.mandatory=o.mandatory||{};o.mandatory[n(e,t)]=r[e]}})}});if(i.advanced){o.optional=(o.optional||[]).concat(i.advanced)}return o};var n=function(r,n){if(a.version>=61){return n(r)}r=JSON.parse(JSON.stringify(r));if(r&&typeof r.audio==="object"){var e=function(e,t,r){if(t in e&&!(r in e)){e[r]=e[t];delete e[t]}};r=JSON.parse(JSON.stringify(r));e(r.audio,"autoGainControl","googAutoGainControl");e(r.audio,"noiseSuppression","googNoiseSuppression");r.audio=c(r.audio)}if(r&&typeof r.video==="object"){var i=r.video.facingMode;i=i&&(typeof i==="object"?i:{ideal:i});var t=a.version<66;if(i&&(i.exact==="user"||i.exact==="environment"||i.ideal==="user"||i.ideal==="environment")&&!(s.mediaDevices.getSupportedConstraints&&s.mediaDevices.getSupportedConstraints().facingMode&&!t)){delete r.video.facingMode;var o;if(i.exact==="environment"||i.ideal==="environment"){o=["back","rear"]}else if(i.exact==="user"||i.ideal==="user"){o=["front"]}if(o){return s.mediaDevices.enumerateDevices().then(function(e){e=e.filter(function(e){return e.kind==="videoinput"});var t=e.find(function(t){return o.some(function(e){return t.label.toLowerCase().indexOf(e)!==-1})});if(!t&&e.length&&o.indexOf("back")!==-1){t=e[e.length-1]}if(t){r.video.deviceId=i.exact?{exact:t.deviceId}:{ideal:t.deviceId}}r.video=c(r.video);d("chrome: "+JSON.stringify(r));return n(r)})}}r.video=c(r.video)}d("chrome: "+JSON.stringify(r));return n(r)};var i=function(e){return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};var t=function(e,t,r){n(e,function(e){s.webkitGetUserMedia(e,t,function(e){if(r){r(i(e))}})})};s.getUserMedia=t;var r=function(r){return new Promise(function(e,t){s.getUserMedia(r,e,t)})};if(!s.mediaDevices){s.mediaDevices={getUserMedia:r,enumerateDevices:function(){return new Promise(function(t){var r={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:r[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:true,echoCancellation:true,facingMode:true,frameRate:true,height:true,width:true}}}}if(!s.mediaDevices.getUserMedia){s.mediaDevices.getUserMedia=function(e){return r(e)}}else{var o=s.mediaDevices.getUserMedia.bind(s.mediaDevices);s.mediaDevices.getUserMedia=function(e){return n(e,function(t){return o(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length){e.getTracks().forEach(function(e){e.stop()});throw new DOMException("","NotFoundError")}return e},function(e){return Promise.reject(i(e))})})}}if(typeof s.mediaDevices.addEventListener==="undefined"){s.mediaDevices.addEventListener=function(){d("Dummy mediaDevices.addEventListener called.")}}if(typeof s.mediaDevices.removeEventListener==="undefined"){s.mediaDevices.removeEventListener=function(){d("Dummy mediaDevices.removeEventListener called.")}}}},{"../utils.js":14}],8:[function(e,t,r){"use strict";var o=e("sdp");var u=e("./utils");t.exports={shimRTCIceCandidate:function(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype){return}var i=t.RTCIceCandidate;t.RTCIceCandidate=function(e){if(typeof e==="object"&&e.candidate&&e.candidate.indexOf("a=")===0){e=JSON.parse(JSON.stringify(e));e.candidate=e.candidate.substr(2)}if(e.candidate&&e.candidate.length){var t=new i(e);var r=o.parseCandidate(e.candidate);var n=Object.assign(t,r);n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}};return n}return new i(e)};t.RTCIceCandidate.prototype=i.prototype;u.wrapPeerConnectionEvent(t,"icecandidate",function(e){if(e.candidate){Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"})}return e})},shimCreateObjectURL:function(e){var t=e&&e.URL;if(!(typeof e==="object"&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL)){return undefined}var r=t.createObjectURL.bind(t);var n=t.revokeObjectURL.bind(t);var i=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;i.set(t,e);u.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream");return t}return r(e)};t.revokeObjectURL=function(e){n(e);i.delete(e)};var a=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return a.get.apply(this)},set:function(e){this.srcObject=i.get(e)||null;return a.set.apply(this,[e])}});var s=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){if(arguments.length===2&&(""+arguments[0]).toLowerCase()==="src"){this.srcObject=i.get(arguments[1])||null}return s.apply(this,arguments)}},shimMaxMessageSize:function(e){if(e.RTCSctpTransport||!e.RTCPeerConnection){return}var i=u.detectBrowser(e);if(!("sctp"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return typeof this._sctp==="undefined"?null:this._sctp}})}var a=function(e){var t=o.splitSections(e.sdp);t.shift();return t.some(function(e){var t=o.parseMLine(e);return t&&t.kind==="application"&&t.protocol.indexOf("SCTP")!==-1})};var s=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(t===null||t.length<2){return-1}var r=parseInt(t[1],10);return r!==r?-1:r};var c=function(e){var t=65536;if(i.browser==="firefox"){if(i.version<57){if(e===-1){t=16384}else{t=2147483637}}else{t=i.version===57?65535:65536}}return t};var l=function(e,t){var r=65536;if(i.browser==="firefox"&&i.version===57){r=65535}var n=o.matchPrefix(e.sdp,"a=max-message-size:");if(n.length>0){r=parseInt(n[0].substr(19),10)}else if(i.browser==="firefox"&&t!==-1){r=2147483637}return r};var d=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;e._sctp=null;if(a(arguments[0])){var t=s(arguments[0]);var r=c(t);var n=l(arguments[0],t);var i;if(r===0&&n===0){i=Number.POSITIVE_INFINITY}else if(r===0||n===0){i=Math.max(r,n)}else{i=Math.min(r,n)}var o={};Object.defineProperty(o,"maxMessageSize",{get:function(){return i}});e._sctp=o}return d.apply(e,arguments)}},shimSendThrowTypeError:function(e){if(!e.RTCPeerConnection){return}var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var n=this;var e=t.apply(n,arguments);var i=e.send;e.send=function(){var e=this;var t=arguments[0];var r=t.length||t.size||t.byteLength;if(r>n.sctp.maxMessageSize){throw new DOMException("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)","TypeError")}return i.apply(e,arguments)};return e}}}},{"./utils":14,sdp:3}],9:[function(e,t,r){"use strict";var n=e("../utils");var i=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=n.detectBrowser(e);if(e.RTCIceGatherer){if(!e.RTCIceCandidate){e.RTCIceCandidate=function(e){return e}}if(!e.RTCSessionDescription){e.RTCSessionDescription=function(e){return e}}if(t.version<15025){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e;this.dispatchEvent(t)}})}}if(e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=new e.RTCDtmfSender(this)}else if(this.track.kind==="video"){this._dtmf=null}}return this._dtmf}})}if(e.RTCDtmfSender&&!e.RTCDTMFSender){e.RTCDTMFSender=e.RTCDtmfSender}e.RTCPeerConnection=i(e,t.version)},shimReplaceTrack:function(e){if(e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)){e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack}}}},{"../utils":14,"./getusermedia":10,"rtcpeerconnection-shim":2}],10:[function(e,t,r){"use strict";t.exports=function(e){var t=e&&e.navigator;var r=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}};var n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(function(e){return Promise.reject(r(e))})}}},{}],11:[function(e,t,r){"use strict";var a=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){if(typeof e==="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){if(this._ontrack){this.removeEventListener("track",this._ontrack);this.removeEventListener("addstream",this._ontrackpoly)}this.addEventListener("track",this._ontrack=e);this.addEventListener("addstream",this._ontrackpoly=function(r){r.stream.getTracks().forEach(function(e){var t=new Event("track");t.track=e;t.receiver={track:e};t.transceiver={receiver:t.receiver};t.streams=[r.stream];this.dispatchEvent(t)}.bind(this))}.bind(this))}})}if(typeof e==="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)){Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}},shimSourceObject:function(e){if(typeof e==="object"){if(e.HTMLMediaElement&&!("srcObject"in e.HTMLMediaElement.prototype)){Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}})}}},shimPeerConnection:function(s){var c=a.detectBrowser(s);if(typeof s!=="object"||!(s.RTCPeerConnection||s.mozRTCPeerConnection)){return}if(!s.RTCPeerConnection){s.RTCPeerConnection=function(e,t){if(c.version<38){if(e&&e.iceServers){var r=[];for(var n=0;n<e.iceServers.length;n++){var i=e.iceServers[n];if(i.hasOwnProperty("urls")){for(var o=0;o<i.urls.length;o++){var a={url:i.urls[o]};if(i.urls[o].indexOf("turn")===0){a.username=i.username;a.credential=i.credential}r.push(a)}}else{r.push(e.iceServers[n])}}e.iceServers=r}}return new s.mozRTCPeerConnection(e,t)};s.RTCPeerConnection.prototype=s.mozRTCPeerConnection.prototype;if(s.mozRTCPeerConnection.generateCertificate){Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get:function(){return s.mozRTCPeerConnection.generateCertificate}})}s.RTCSessionDescription=s.mozRTCSessionDescription;s.RTCIceCandidate=s.mozRTCIceCandidate}["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=s.RTCPeerConnection.prototype[e];s.RTCPeerConnection.prototype[e]=function(){arguments[0]=new(e==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]);return t.apply(this,arguments)}});var e=s.RTCPeerConnection.prototype.addIceCandidate;s.RTCPeerConnection.prototype.addIceCandidate=function(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}return e.apply(this,arguments)};var n=function(t){var r=new Map;Object.keys(t).forEach(function(e){r.set(e,t[e]);r[e]=t[e]});return r};var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};var o=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(e,t,r){return o.apply(this,[e||null]).then(function(r){if(c.version<48){r=n(r)}if(c.version<53&&!t){try{r.forEach(function(e){e.type=i[e.type]||e.type})}catch(e){if(e.name!=="TypeError"){throw e}r.forEach(function(e,t){r.set(t,Object.assign({},e,{type:i[e.type]||e.type}))})}}return r}).then(t,r)}},shimRemoveStream:function(e){if(!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype){return}e.RTCPeerConnection.prototype.removeStream=function(t){var r=this;a.deprecated("removeStream","removeTrack");this.getSenders().forEach(function(e){if(e.track&&t.getTracks().indexOf(e.track)!==-1){r.removeTrack(e)}})}}}},{"../utils":14,"./getusermedia":12}],12:[function(e,t,r){"use strict";var p=e("../utils");var g=p.log;t.exports=function(e){var i=p.detectBrowser(e);var o=e&&e.navigator;var t=e&&e.MediaStreamTrack;var a=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the "+"user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}};var n=function(e,t,r){var n=function(n){if(typeof n!=="object"||n.require){return n}var i=[];Object.keys(n).forEach(function(e){if(e==="require"||e==="advanced"||e==="mediaSource"){return}var t=n[e]=typeof n[e]==="object"?n[e]:{ideal:n[e]};if(t.min!==undefined||t.max!==undefined||t.exact!==undefined){i.push(e)}if(t.exact!==undefined){if(typeof t.exact==="number"){t.min=t.max=t.exact}else{n[e]=t.exact}delete t.exact}if(t.ideal!==undefined){n.advanced=n.advanced||[];var r={};if(typeof t.ideal==="number"){r[e]={min:t.ideal,max:t.ideal}}else{r[e]=t.ideal}n.advanced.push(r);delete t.ideal;if(!Object.keys(t).length){delete n[e]}}});if(i.length){n.require=i}return n};e=JSON.parse(JSON.stringify(e));if(i.version<38){g("spec: "+JSON.stringify(e));if(e.audio){e.audio=n(e.audio)}if(e.video){e.video=n(e.video)}g("ff37: "+JSON.stringify(e))}return o.mozGetUserMedia(e,t,function(e){r(a(e))})};var r=function(r){return new Promise(function(e,t){n(r,e,t)})};if(!o.mediaDevices){o.mediaDevices={getUserMedia:r,addEventListener:function(){},removeEventListener:function(){}}}o.mediaDevices.enumerateDevices=o.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})};if(i.version<41){var s=o.mediaDevices.enumerateDevices.bind(o.mediaDevices);o.mediaDevices.enumerateDevices=function(){return s().then(undefined,function(e){if(e.name==="NotFoundError"){return[]}throw e})}}if(i.version<49){var c=o.mediaDevices.getUserMedia.bind(o.mediaDevices);o.mediaDevices.getUserMedia=function(t){return c(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length){e.getTracks().forEach(function(e){e.stop()});throw new DOMException("The object can not be found here.","NotFoundError")}return e},function(e){return Promise.reject(a(e))})}}if(!(i.version>55&&"autoGainControl"in o.mediaDevices.getSupportedConstraints())){var l=function(e,t,r){if(t in e&&!(r in e)){e[r]=e[t];delete e[t]}};var d=o.mediaDevices.getUserMedia.bind(o.mediaDevices);o.mediaDevices.getUserMedia=function(e){if(typeof e==="object"&&typeof e.audio==="object"){e=JSON.parse(JSON.stringify(e));l(e.audio,"autoGainControl","mozAutoGainControl");l(e.audio,"noiseSuppression","mozNoiseSuppression")}return d(e)};if(t&&t.prototype.getSettings){var u=t.prototype.getSettings;t.prototype.getSettings=function(){var e=u.apply(this,arguments);l(e,"mozAutoGainControl","autoGainControl");l(e,"mozNoiseSuppression","noiseSuppression");return e}}if(t&&t.prototype.applyConstraints){var f=t.prototype.applyConstraints;t.prototype.applyConstraints=function(e){if(this.kind==="audio"&&typeof e==="object"){e=JSON.parse(JSON.stringify(e));l(e,"autoGainControl","mozAutoGainControl");l(e,"noiseSuppression","mozNoiseSuppression")}return f.apply(this,[e])}}}o.getUserMedia=function(e,t,r){if(i.version<44){return n(e,t,r)}p.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");o.mediaDevices.getUserMedia(e).then(t,r)}}},{"../utils":14}],13:[function(e,t,r){"use strict";var a=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if(typeof e!=="object"||!e.RTCPeerConnection){return}if(!("getLocalStreams"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.getLocalStreams=function(){if(!this._localStreams){this._localStreams=[]}return this._localStreams}}if(!("getStreamById"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.getStreamById=function(t){var r=null;if(this._localStreams){this._localStreams.forEach(function(e){if(e.id===t){r=e}})}if(this._remoteStreams){this._remoteStreams.forEach(function(e){if(e.id===t){r=e}})}return r}}if(!("addStream"in e.RTCPeerConnection.prototype)){var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(t){if(!this._localStreams){this._localStreams=[]}if(this._localStreams.indexOf(t)===-1){this._localStreams.push(t)}var r=this;t.getTracks().forEach(function(e){n.call(r,e,t)})};e.RTCPeerConnection.prototype.addTrack=function(e,t){if(t){if(!this._localStreams){this._localStreams=[t]}else if(this._localStreams.indexOf(t)===-1){this._localStreams.push(t)}}return n.call(this,e,t)}}if(!("removeStream"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.removeStream=function(e){if(!this._localStreams){this._localStreams=[]}var t=this._localStreams.indexOf(e);if(t===-1){return}this._localStreams.splice(t,1);var r=this;var n=e.getTracks();this.getSenders().forEach(function(e){if(n.indexOf(e.track)!==-1){r.removeTrack(e)}})}}},shimRemoteStreamsAPI:function(e){if(typeof e!=="object"||!e.RTCPeerConnection){return}if(!("getRemoteStreams"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}}if(!("onaddstream"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var r=this;if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=e);this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(!r._remoteStreams){r._remoteStreams=[]}if(r._remoteStreams.indexOf(e)>=0){return}r._remoteStreams.push(e);var t=new Event("addstream");t.stream=e;r.dispatchEvent(t)})})}})}},shimCallbacksAPI:function(e){if(typeof e!=="object"||!e.RTCPeerConnection){return}var t=e.RTCPeerConnection.prototype;var i=t.createOffer;var o=t.createAnswer;var a=t.setLocalDescription;var s=t.setRemoteDescription;var c=t.addIceCandidate;t.createOffer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0];var n=i.apply(this,[r]);if(!t){return n}n.then(e,t);return Promise.resolve()};t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0];var n=o.apply(this,[r]);if(!t){return n}n.then(e,t);return Promise.resolve()};var r=function(e,t,r){var n=a.apply(this,[e]);if(!r){return n}n.then(t,r);return Promise.resolve()};t.setLocalDescription=r;r=function(e,t,r){var n=s.apply(this,[e]);if(!r){return n}n.then(t,r);return Promise.resolve()};t.setRemoteDescription=r;r=function(e,t,r){var n=c.apply(this,[e]);if(!r){return n}n.then(t,r);return Promise.resolve()};t.addIceCandidate=r},shimGetUserMedia:function(e){var n=e&&e.navigator;if(!n.getUserMedia){if(n.webkitGetUserMedia){n.getUserMedia=n.webkitGetUserMedia.bind(n)}else if(n.mediaDevices&&n.mediaDevices.getUserMedia){n.getUserMedia=function(e,t,r){n.mediaDevices.getUserMedia(e).then(t,r)}.bind(n)}}},shimRTCIceServerUrls:function(e){var o=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){var r=[];for(var n=0;n<e.iceServers.length;n++){var i=e.iceServers[n];if(!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")){a.deprecated("RTCIceServer.url","RTCIceServer.urls");i=JSON.parse(JSON.stringify(i));i.urls=i.url;delete i.url;r.push(i)}else{r.push(e.iceServers[n])}}e.iceServers=r}return new o(e,t)};e.RTCPeerConnection.prototype=o.prototype;if("generateCertificate"in e.RTCPeerConnection){Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return o.generateCertificate}})}},shimTrackEventTransceiver:function(e){if(typeof e==="object"&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver){Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}},shimCreateOfferLegacy:function(e){var i=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var t=this;if(e){var r=t.getTransceivers().find(function(e){return e.sender.track&&e.sender.track.kind==="audio"});if(e.offerToReceiveAudio===false&&r){if(r.direction==="sendrecv"){if(r.setDirection){r.setDirection("sendonly")}else{r.direction="sendonly"}}else if(r.direction==="recvonly"){if(r.setDirection){r.setDirection("inactive")}else{r.direction="inactive"}}}else if(e.offerToReceiveAudio===true&&!r){t.addTransceiver("audio")}var n=t.getTransceivers().find(function(e){return e.sender.track&&e.sender.track.kind==="video"});if(e.offerToReceiveVideo===false&&n){if(n.direction==="sendrecv"){n.setDirection("sendonly")}else if(n.direction==="recvonly"){n.setDirection("inactive")}}else if(e.offerToReceiveVideo===true&&!n){t.addTransceiver("video")}}return i.apply(t,arguments)}}}},{"../utils":14}],14:[function(e,t,r){"use strict";var n=true;var i=true;function o(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function a(e,n,i){if(!e.RTCPeerConnection){return}var t=e.RTCPeerConnection.prototype;var o=t.addEventListener;t.addEventListener=function(e,t){if(e!==n){return o.apply(this,arguments)}var r=function(e){t(i(e))};this._eventMap=this._eventMap||{};this._eventMap[t]=r;return o.apply(this,[e,r])};var a=t.removeEventListener;t.removeEventListener=function(e,t){if(e!==n||!this._eventMap||!this._eventMap[t]){return a.apply(this,arguments)}var r=this._eventMap[t];delete this._eventMap[t];return a.apply(this,[e,r])};Object.defineProperty(t,"on"+n,{get:function(){return this["_on"+n]},set:function(e){if(this["_on"+n]){this.removeEventListener(n,this["_on"+n]);delete this["_on"+n]}if(e){this.addEventListener(n,this["_on"+n]=e)}}})}t.exports={extractVersion:o,wrapPeerConnectionEvent:a,disableLog:function(e){if(typeof e!=="boolean"){return new Error("Argument type: "+typeof e+". Please use a boolean.")}n=e;return e?"adapter.js logging disabled":"adapter.js logging enabled"},disableWarnings:function(e){if(typeof e!=="boolean"){return new Error("Argument type: "+typeof e+". Please use a boolean.")}i=!e;return"adapter.js deprecation warnings "+(e?"disabled":"enabled")},log:function(){if(typeof window==="object"){if(n){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}},deprecated:function(e,t){if(!i){return}console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var t=e&&e.navigator;var r={};r.browser=null;r.version=null;if(typeof e==="undefined"||!e.navigator){r.browser="Not a browser.";return r}if(t.mozGetUserMedia){r.browser="firefox";r.version=o(t.userAgent,/Firefox\/(\d+)\./,1)}else if(t.webkitGetUserMedia){r.browser="chrome";r.version=o(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/)){r.browser="edge";r.version=o(t.userAgent,/Edge\/(\d+).(\d+)$/,2)}else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./)){r.browser="safari";r.version=o(t.userAgent,/AppleWebKit\/(\d+)\./,1)}else{r.browser="Not a supported browser.";return r}return r}}},{}]},{},[4])(4)})}).call(e,t(0))},,,,,function(e,t,r){r(10);r(4);e.exports=r(11)},function(e,t){window.ScreenChromeExtensionUtil={};(function(e){window.addEventListener("message",function(e){if(e.origin!=window.location.origin){return}t(e.data)});function t(e){if(e=="PermissionDeniedError"){n="PermissionDeniedError";if(r)return r("PermissionDeniedError");else throw new Error("PermissionDeniedError")}if(e=="rtcmulticonnection-extension-loaded"){n="desktop"}if(e.sourceId&&r){r(i=e.sourceId)}}var n="screen";var i;var r;function o(e){if(!e)return;if(n=="desktop")return e(true);window.postMessage("are-you-there","*");setTimeout(function(){if(n=="screen"){e(false)}else e(true)},2e3)}function a(e){if(!e)throw'"callback" parameter is mandatory.';if(i)return e(i);r=e;window.postMessage("get-sourceId","*")}var s=typeof window.InstallTrigger!=="undefined";var c=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;var l=!!window.chrome&&!c;function d(e,t){if(s)return t("not-chrome");if(arguments.length!=2){t=e;e="igbnnaaplbclljbpbhaplekapmfegkmg"}var r=document.createElement("img");r.src="chrome-extension://"+e+"/qcloud.png";r.onload=function(){n="screen";window.postMessage("are-you-there","*");setTimeout(function(){if(n=="screen"){t(e==e?"installed-enabled":"installed-disabled")}else t("installed-enabled")},100)};r.onerror=function(){t("not-installed")}}function u(e){var t={mozMediaSource:"window",mediaSource:"window"};if(s)return e(null,t);var r={mandatory:{chromeMediaSource:n,maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[]};if(n=="desktop"&&!i){a(function(){r.mandatory.chromeMediaSourceId=i;e(i=="PermissionDeniedError"?i:null,r)});return}if(n=="desktop"){r.mandatory.chromeMediaSourceId=i}e(null,r)}e.isChromeExtensionAvailable=o;e.getScreenConstraints=u;e.getChromeExtensionStatus=d})(ScreenChromeExtensionUtil)},function(module,exports,__webpack_require__){"use strict";var WebRTCStat={Info:{MediaList:[],Video:null},DataEnum:{terminal_type:["mobile","iphone","ipad","andriod phone","pc","windows pad ","windows phone ","android pad","voip","mac","pstn"]},getTerminalType:function(){var r="";var n="";var e=navigator.userAgent.toLowerCase();if(e.indexOf("iphone")!==-1){r="iphone"}else if(e.indexOf("android")!==-1){r="andriod phone"}else if(e.indexOf("ipad")!==-1){r="ipad"}else if(e.indexOf("macintosh")!==-1){r="mac"}else if(e.indexOf("windows")!==-1){r="pc"}else{r="pc"}this.DataEnum.terminal_type.forEach(function(e,t){if(e.toLowerCase().indexOf(r)!==-1){n=t+1}});return String(n)},getVideoSrcType:function(){var e=1;var t=parseInt(this.getTerminalType());var r=this.DataEnum.terminal_type[t-1];if(r==="andriod phone"){e=4}else if(r==="ipad"){e=5}else if(r==="iphone"){e=6}return e},getDeviceInfo:function(){var t=this;navigator.mediaDevices.enumerateDevices().then(function(e){e.forEach(function(e){if(e.kind==="videoinput"&&!t.Info.Video){t.Info.Video={kind:e.kind,label:e.label,id:e.deviceId}}})}).catch(function(e){console.log(e.name+": "+e.message)})},getExplore:function(){var e={};var t=navigator.userAgent.toLowerCase();var r;(r=t.match(/rv:([\d.]+)\) like gecko/))?e.ie=r[1]:(r=t.match(/msie ([\d\.]+)/))?e.ie=r[1]:(r=t.match(/edge\/([\d\.]+)/))?e.edge=r[1]:(r=t.match(/firefox\/([\d\.]+)/))?e.firefox=r[1]:(r=t.match(/(?:opera|opr).([\d\.]+)/))?e.opera=r[1]:(r=t.match(/chrome\/([\d\.]+)/))?e.chrome=r[1]:(r=t.match(/version\/([\d\.]+).*safari/))?e.safari=r[1]:0;if(e.ie)return"IE: "+e.ie;if(e.edge)return"EDGE: "+e.edge;if(e.firefox)return"Firefox: "+e.firefox;if(e.chrome)return"Chrome: "+e.chrome;if(e.opera)return"Opera: "+e.opera;if(e.safari)return"Safari: "+e.safari;return"Unkonwn"},ability:function(e){var t=0;if(navigator&&navigator.connection&&navigator.connection.type){if(navigator.connection.type==="wifi"){t=1}else if(navigator.connection.type==="cellular"){t=4}}var r=0;if(navigator&&navigator.cpuMaxFrequency){r=navigator.cpuMaxFrequency}var n=0;if(navigator&&navigator.totalMemory){n=navigator.totalMemory}var i="";if(navigator&&navigator.cpuModelName){i=navigator.cpuModelName}var o=parseInt(this.getTerminalType());var a=this.DataEnum.terminal_type[o-1];var s="";try{s=this.getExplore()}catch(e){}return{AbilityOption:{GeneralLimit:{CPULimit:{uint32_CPU_num:String(navigator.hardwareConcurrency||0),str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:String(r),model:i,uint32_total_memory:String(n)},uint32_terminal_type:WebRTCStat.getTerminalType(),uint32_device_type:String(0),str_os_verion:a,uint32_link_type:String(1),str_client_version:String(WebRTCAPI.version||"0"),uint32_net_type:String(t),ua:navigator.userAgent,version:s},VideoLimit:{CameraLimit:{str_camera_auth_name:WebRTCStat.Info.Video&&WebRTCStat.Info.Video.label,uint32_video_src_type:WebRTCStat.getVideoSrcType()},uint32_screen_width:String(window.screen.width),uint32_screen_height:String(window.screen.height)},SpeciParam:{SpeciVidParam:{uint32_spcivid_proto:String(3),uint32_spcivid_width:String(640),uint32_spcivid_height:String(368),uint32_spcivid_fps:String(20)},SpeciAudParam:{uint32_spciaud_fs:String(48e3),uint32_spciaud_ch:String(2)}}}}},isSupport:function(){var t=false;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){if(t){return}if(e in window){t=true}});return t},init:function(){if(this.isSupport()){this.getDeviceInfo()}}};WebRTCStat.init();window.WebRTCAPI={version:22,GLOBAL:{AudioContext:null,PeerConnections:null},init:function(e,t){},createRoom:function(e,t){},startWebRTC:function(e){},closeVideo:function(){},openVideo:function(){},closeAudio:function(){},openAudio:function(){},quit:function(){},createDataChannel:function(){},recreateDataChannel:function(){},sendDCData:function(e){}};var webrtc={init:function(e,t){},createRoom:function(e,t){},startWebRTC:function(e){},setlistener:function(e){},closeVideo:function(){},closeAudio:function(){},openVideo:function(){},openAudio:function(){},setMicVolume:function(e){},setConstraints:function(){},changeSpearRole:function(e){},getOpenId:function(e){},quit:function(){},wsreconnect:function(e){},createDataChannel:function(){},recreateDataChannel:function(){},sendDCData:function(e){},chooseVideoDevice:function(e){},chooseAudioDevice:function(e){}};(function(webrtc){var SERVER_TYPE={FOR_EDU:1,FOR_OPEN:2};var CURRENT_SERVER_TYPE=SERVER_TYPE.FOR_OPEN;var SvrDomain="qcloud.rtc.qq.com";if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_EDU){SvrDomain="edu.rtc.qq.com"}if(/test(\d*)\.rtc\.qq\.com/.test(document.domain)){SvrDomain=document.domain}var Util={query:function(e){var t=window.location.search.match(new RegExp("(\\?|&)"+e+"=([^&]*)(&|$)"));return!t?"":decodeURIComponent(t[2])},getHash:function(e){var t=window.location.hash.match(new RegExp("(#|&)"+e+"=([^&]*)(&|$)"));return!t?"":decodeURIComponent(t[2])}};function WebSocketClient(){this.instance=null;this.autoReconnectInterval=3*1e3;this.retryCount=5;this.url=null;this.hasConnect=false;this.relayInfo={innerip:null,outterip:null,dataport:0,stunport:0};this.sessioninfo={openid:null,tinyid:null,srcids:[],sessionid:0,peersdp:{}};this.reconnectTimer=null}WebSocketClient.prototype.open=function(e,t){uploadWebLog("[WebSocketClient : begin connection websocket server, url = ] "+e,null,"WebSocketTag");var r=t||e;this.url=r;if(this.instance){try{uploadWebLog("[WebSocketClient : old instance is not close! close it before create the new one! old readyState = ]"+this.instance.readyState+" , old url = "+this.instance.url,null,"WebSocketTag");this.instance.close(1e3);this.instance=null}catch(e){uploadWebLog("[WebSocketClient close last instance error : ]"+e.message,null,"WebSocketTag");console.error("WebSocketClient close last instance error : ",e)}}this.instance=new WebSocket(e);var n=this;this.instance.onopen=function(){uploadWebLog("[WebSocketClient instance is open success!!!]",null,"WebSocketTag");console.info("websocketclient instance on open!");n.hasConnect=true;n.retryCount=5;n.onopen()};this.instance.onerror=function(e){console.error("websocketclient instance on error!",e);uploadWebLog("[WebSocketClient instance onerror! url = ]"+e.currentTarget.url,null,"WebSocketTag");n.onerror(e)};this.instance.onclose=function(e){console.warn("websocketclient instance close!");uploadWebLog("[WebSocketClient instance close!, code = ]"+e.code+" , url = "+e.currentTarget.url,null,"WebSocketTag");switch(e.code){case 1e3:n.onclose(e);break;case 1006:n.onclose(e);break;case 4010:if(n.retryCount<=0){n.onclose(e)}else{n.onneedreconnect(e)}break;default:n.onclose(e);break}};this.instance.onmessage=function(e){n.onmessage(e)}};WebSocketClient.prototype.onopen=function(){console.info("WebSocketClient : onopen ",arguments)};WebSocketClient.prototype.onmessage=function(e){};WebSocketClient.prototype.onerror=function(e){console.error("WebSocketClient : onerror ",arguments)};WebSocketClient.prototype.onclose=function(e){console.warn("WebSocketClient : onclose",arguments)};WebSocketClient.prototype.onneedreconnect=function(e){uploadWebLog("[WebSocketClient --\x3e on need reconnect websocket!!!]",null,"WEBSOCKET");console.warn("WebSocketClient : onreconnect",arguments)};WebSocketClient.prototype.close=function(){uploadWebLog("[WebSocketClient --\x3e on close!]");clearTimeout(this.reconnectTimer);if(this.instance){this.instance.close(1e3);this.instance=null}this.hasConnect=false;this.url=null;this.relayInfo={innerip:null,outterip:null,dataport:0,stunport:0};this.sessioninfo={openid:null,tinyid:null,srcids:[],peersdp:{}};this.retryCount=3};WebSocketClient.prototype.reconnect=function(e){uploadWebLog("[WebSocketClient --\x3e begin reconnect!!! sig = ]"+e);console.warn("websocketclient try reconnect!");var t=this;if(e){this.url=this.replaceURLValue(this.url,"userSig",e)}this.reconnectTimer=setTimeout(function(){if(t.retryCount<=0){t.close();return}t.retryCount--;uploadWebLog("[WebSocketClient --\x3e reconnectting!!!]");console.warn("websocketclient reconnectting");if(!t.hasConnect){t.open(t.url)}else{var e=t.url+"&iip="+t.relayInfo.innerip+"&dp="+t.relayInfo.dataport+"&oip="+t.relayInfo.outterip+"&sp="+t.relayInfo.stunport+"&rc=1";t.open(e,t.url)}},this.autoReconnectInterval)};WebSocketClient.prototype.send=function(e){if(this.instance){this.instance.send(e)}};WebSocketClient.prototype.replaceURLValue=function(url,paramName,replaceWith){var re=eval("/("+paramName+"=)([^&]*)/gi");return url.replace(re,paramName+"="+replaceWith)};var global=new function(){this.deviceInfo={hasVideo:false,hasAudio:false};this.VERSION=WebRTCAPI.version;this.checkSigSeq=null;this.relayip=null;this.localip=null;this.signalip=null;this.ostype=null;this.cpunum=0;this.cpuname=null;this.devicename=null;this.dataport=null;this.stunport=null;this.stunportList=null;this.websocket=null;this.peerConnection=null;this.peerConnections={};this.remoteStreams={};this.preReportData=null;this.WEBRTC_WS_SERVER="wss://"+SvrDomain+":8687";this.WEBRTC_STUN_SERVER="";this.WEBRTC_CGI_URL="https://qcloud.rtc.qq.com:8687/api/uploadlog";if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_EDU){this.WEBRTC_CGI_URL="https://edu.rtc.qq.com:8687/api/uploadlog"}this.config={sdkAppId:"",openid:"",tinyid:"",srctinyid:"",userSig:"",accountType:"",closeLocalMedia:false,audio:true,video:true};this.reportSto=null;this.reportTime=0;this.roomid=-1;this.localStream=null;this.specifyConstraints=null;this.gainNode=null;this.constraints={audio:true,video:true};this.offerSdpOption={offerToReceiveAudio:true,offerToReceiveVideo:true,voiceActivityDetection:false};this.hasRetryOpenCamera=false;this.openIdMap={};this.RTC_EVENT={ON_PEER_SDP:"on_peer_sdp",ON_UPDATE_PEER_SDP:"on_update_peer_sdp",ON_PEER_CANDIDATE:"on_peer_candidate",ON_BIND_SESSION:"on_bind_session",ON_MEDIA_CHANGE:"on_media_change",ON_START_CHAT:"on_start_chat",ON_QUIT_CHAT:"on_quit_chat",ON_CREATE_ROOM:"on_create_room",ON_CREATE_PEER:"on_create_peer",ON_QUALITY_REPORT:"on_quality_report",ON_GET_USER_MEDIA_FAILED:"on_get_user_media_failed",ON_GET_LOACL_SDP_FAILED:"on_get_local_sdp_failed",ON_SET_REMOTE_SDP_FAILED:"on_set_remote_sdp_failed",ON_GET_LOCAL_CANDIDATE_FAILED:"on_get_local_candidate_failed",ON_SET_REMOTE_CANDIDATE_FAILED:"on_set_remote_candidate_failed",ON_GET_SRC_PEER_CONNECTION_FAILED:"on_get_srctinyid_peerconnection_failed",ON_SET_REMOTE_CANDIDATE_SUC:"on_set_remote_candidate_suc",ON_SET_REMOTE_SDP_SUC:"on_set_remote_sdp_suc",ON_ICE_COMPLETE:"on_ice_complete",ON_ICE_BROKEN:"on_ice_broken",ON_START_WEBRTC_FAILED_WITHOUT_CALLBACK:"on_start_webrtc_failed_without_callback",ON_CREATE_PEERCONNECTION_FAILED:"on_create_peerconnection_failed",ON_END_REPORT:"on_end_report",ON_SPEAR_ROLE_CHANGE:"on_spear_role_change",ON_REBUILD_SESSION:"on_rebuild_session",ON_GET_USER_MEDIA_OK:"on_get_user_media_ok",ON_START_WEBRTC:"on_start_webrtc",ON_GET_USER_MEDIA:"on_get_user_media",ON_UPLOAD_WEB_LOG:"on_upload_web_log",INIT_END_REPORT:"init_end_report",ON_GET_MAX_TIMEMS:"on_get_max_timems",ON_NOT_SUPPORT_H264:"on_not_support_h264",ON_STUN_FAILED:"on_stun_failed"};this.KEY_TAG={WEBSOCKET_TAG:"websocket_tag",SDP_TAG:"sdp_tag",CANDIDATE_TAG:"candidate_tag",USER_MEDIA_TAG:"user_media_tag",UPDATE_VIDEO_SSRC_TAG:"update_video_ssrc_tag",UPDATE_AUDIO_SSRC_TAG:"update_audio_ssrc_tag",UPDATE_LOCAL_MEDIA_STREAM_TAG:"update_local_media_stream_tag",UPDATE_SUB_VIDEO_TAG:"update_sub_video_tag",RTC_LOG_TAG:"rtc_log_tag",WEBSOCKET_BUILD_FAILED_TAG:"websocket_build_failed_tag",WEBSOCKET_REBUILD_TAG:"websocket_rebuild_tag",REPORT_TIME_OUT_TAG:"report_timeout"};this.MEDIA_CHANGE={OPEN_VIDEO:1,CLOSE_VIDEO:2,OPEN_AUDIO:3,CLOSE_AUDIO:4};this.WS_CMD={SDP:2,CANDIDATE:4,MEDIA_CHANGE:13,START_CHAT:6,QUIT_CHAT:8,ON_STAGE:12,WS_INIT_OK:19,WS_INIT_FAILED:80,CREATE_ROOM_RESULT:20,NOTIFY_CREATE_PEER_CONNECTION:16,NOTIFY_CREATE_PEER_CONNECTION_RES:17,NOTIFY_CLOSE_PEER_CONNECTION:18,NOTIFY_CHANGE_CONSTRAINTS:32,NOTIFY_SUB_VIDEO_STATE:48,NOTIFY_UPDATE_AUDIO_SSRC:50,NOTIFY_UPDATE_VIDEO_SSRC:52,NOTIFY_MAX_TIMEMS:770,NOTIFY_RECONNECT_DC:529};this.STREAM_TYPE={NONE:0,AUDIO:1,MAIN:2,AID:7};this.STREAM_MISD={MAIN:"5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",AID:"224d130c-7b5c-415b-aaa2-79c2eb5a6df2"};this.USER_DEFINED_EVENT={WEBSOCKET_INIT:"websocket_init",WEBSOCKET_INIT_OK:"websocket_init_ok",RECEIVE_CREATE_PEER:"receive_create_pc",BEGIN_CREATE_PEER:"begin_create_pc",CREATE_PC_SUC:"create_pc_suc",CREATE_PC_FAILED:"create_pc_failed",BEGIN_START_WEBRTC:"begin_start_webrtc",GET_LOCAL_SDP_SUC:"get_local_sdp_suc",GET_LOCAL_SDP_FAILED:"get_local_sdp_failed",RECEIVE_REMOTE_SDP:"receive_remote_sdp",SET_REMOTE_SDP_SUC:"set_remote_sdp_suc",SET_REMOTE_SDP_FAILED:"set_remote_sdp_failed",GET_LOCAL_CANDIDATE_SUC:"get_local_candidate_suc",GET_LOCAL_STUN_IP_FAILED:"get_local_stun_ip_failed",RECEIVE_REMOTE_CANDIDATE:"receive_remote_candidate",SET_REMOTE_CANDIDATE_SUC:"set_remote_candidate_suc",SET_REMOTE_CANDIDATE_FAILED:"set_remote_candidate_failed",ON_ICE_STATE_CHANGE:"on_ice_state_change",ON_ICE_GATHERING_STATE_CHANGE:"on_ice_gathering_state_change",ON_WEBSOCKET_CLOSE_BY_NETWORK_BROKEN:"on_websocket_close_by_network_broken",NOTICE_PEERCONNECTION:"notice_pc"};this.extensionId="igbnnaaplbclljbpbhaplekapmfegkmg"};function addCommonInfoInQualityReport(e,t,r,n,i,o,a,s,c){e["socketid"]=global.websocket.socketid;e["tinyid"]=o;e["clientip"]=i;e["devicename"]=r;e["ostype"]=t;e["sdkAppId"]=global.config.sdkAppId;e["roomid"]=a;e["serverip"]=n;e["cpunumber"]=s;e["cpudevice"]=c;return e}function initEndReport(e,t,r,n,i,o,a,s){var c=createJsonFromTag(global.RTC_EVENT.INIT_END_REPORT);c.data={socketid:global.websocket.socketid,tinyid:i,clientip:n,devicename:t,ostype:e,sdkAppId:global.config.sdkAppId,roomid:o,serverip:r,cpunumber:a,cpudevice:s};global.websocket.send(JSON.stringify(c));console.log("init end report")}var ICE_BUILD_STATE={SUC:0,SDP_FAILED:1,CANDIDATE_FAILED:2,H264_NOT_SUPPORT:3,GET_STUN_IP_FAILED:4};function endEndReport(e){try{if(!global.websocket||!global.websocket.socketid){rtcLog.warn("do not send endreason to server, the socketid is null!");return}var t=createJsonFromTag(global.RTC_EVENT.ON_END_REPORT);t.data={dwExitRoomTime:(new Date).getTime(),dwEndResult:e,socketid:global.websocket.socketid};if(global.websocket){global.websocket.send(JSON.stringify(t))}}catch(e){rtcLog.error("send end report data error : "+e.message)}}var rtclistener=new function(){this.config={onRemoteLeave:null,onLocalStreamAdd:null,onPeerStreamAdd:null,onPeerStreamRemove:null,onRemoteStreamUpdate:null,onMediaChange:null,onCreateRoomResult:null,onCreatePeerResult:null,onWebSocketInit:null,onWSClose:null,onIceConnectionClose:null,onIceConnectionFailed:null,onRelayTimeout:null,onIceConnectionBuild:null,onKeylogWrite:null,onWebSocketReconnection:null,onUserDefinedWebRTCEventNotice:null}};var createVConsole=function(){var e=document.createElement("script");e.src="https://sqimg.qq.com/expert_qq/webrtc/vconsole.min.js";document.body.appendChild(e)};function uploadWebLog(e,t,r){try{if(!window.XMLHttpRequest){console.error("XMLHttpRequest not support!");return}if(!global.WEBRTC_CGI_URL){console.warn("CGI URL not ready!");return}var n=new XMLHttpRequest;n.open("POST",global.WEBRTC_CGI_URL,true);n.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(t){e+=" \r\n "+JSON.stringify({OBJ:t})}var i=JSON.stringify({localip:global.localip,relayip:global.relayip,signalip:global.signalip,tinyid:global.config.tinyid,openid:global.config.openid,appid:global.config.sdkAppId,tag:r,log:e});n.send("data="+i)}catch(e){console.error("upload log error : ",e)}}var rtcLog=new function(){var r="WEBRTC_API : ";this._debugLogOpen=Util.query("debug")||false;this._uploadLogOpen=Util.query("uploadlog")||false;if(Util.query("debug")){createVConsole()}this.LOG_LEVEL={RTC_LOG_DEBUG:"RTC_LOG_DEBUG",RTC_LOG_INFO:"RTC_LOG_INFO",RTC_LOG_WARN:"RTC_LOG_WARN",RTC_LOG_ERROR:"RTC_LOG_ERROR"};this.error=function(e,t){if(!t){console.error(r+e)}else{console.error(r+e,t)}this.uploadLog(e,t,this.LOG_LEVEL.RTC_LOG_ERROR);if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_EDU){if(rtclistener.config.onKeylogWrite){rtclistener.config.onKeylogWrite(this.LOG_LEVEL.RTC_LOG_ERROR,e,t)}}};this.debug=function(e,t){if(!this._debugLogOpen){return}if(!t){console.log(r+e)}else{console.log(r+e,t)}};this.info=function(e,t){if(!t){console.info(r+e)}else{console.info(r+e,t)}this.uploadLog(e,t,this.LOG_LEVEL.RTC_LOG_INFO);if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_EDU){if(rtclistener.config.onKeylogWrite){rtclistener.config.onKeylogWrite(this.LOG_LEVEL.RTC_LOG_INFO,e,t)}}};this.warn=function(e,t){if(!t){console.warn(r+e)}else{console.warn(r+e,t)}this.uploadLog(e,t,this.LOG_LEVEL.RTC_LOG_WARN);if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_EDU){if(rtclistener.config.onKeylogWrite){rtclistener.config.onKeylogWrite(this.LOG_LEVEL.RTC_LOG_WARN,e,t)}}};this.uploadLog=function(e,t,r){if(!this._uploadLogOpen){return}uploadWebLog(e,t,global.KEY_TAG.RTC_LOG_TAG)}};var initWebSocket=function(e){try{uploadWebLog("begin init websocket",null,global.KEY_TAG.WEBSOCKET_TAG);rtclistener.config.onWebSocketInit=e;var t=encodeURIComponent(global.config.openid).replace(/'/g,"%27").replace(/"/g,"%22");var r=global.WEBRTC_WS_SERVER+"?"+"userSig="+global.config.userSig+"&sdkAppid="+global.config.sdkAppId+"&identifier="+t;if(global.websocket){try{uploadWebLog("create a websocket instance, but the old one not destroy! close the old one!",null,global.KEY_TAG.WEBSOCKET_TAG);global.websocket.close()}catch(e){console.error(e)}global.websocket=null}if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.WEBSOCKET_INIT,null)}global.websocket=new WebSocketClient;global.websocket.onmessage=wsonmessage;global.websocket.onopen=wsonopen;global.websocket.onclose=wsonclose;global.websocket.onneedreconnect=wsonneedreconnect;global.websocket.open(r)}catch(e){var n="init web socket failed!!! exception = "+e.message;rtclistener.config.onWebSocketInit({result:-10005,error:n});uploadWebLog(n,null,global.KEY_TAG.WEBSOCKET_BUILD_FAILED_TAG);rtcLog.error(n)}};var setlistener=function(e){if(!e.onRemoteLeave||!e.onLocalStreamAdd||!e.onPeerStreamAdd||!e.onPeerStreamRemove||!e.onMediaChange){rtcLog.error("listener is empty!!!");return false}rtclistener.config.onMediaChange=e.onMediaChange;rtclistener.config.onRemoteLeave=e.onRemoteLeave;rtclistener.config.onLocalStreamAdd=e.onLocalStreamAdd;rtclistener.config.onPeerStreamAdd=e.onPeerStreamAdd;rtclistener.config.onPeerStreamRemove=e.onPeerStreamRemove;rtclistener.config.onRemoteStreamUpdate=e.onRemoteStreamUpdate;rtclistener.config.onWSClose=e.onWSClose;rtclistener.config.onRelayTimeout=e.onRelayTimeout;rtclistener.config.onKickout=e.onKickout;rtclistener.config.onIceConnectionClose=e.onIceConnectionClose;if(e.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild=e.onIceConnectionBuild}if(e.onQualityReport){rtclistener.config.onQualityReport=e.onQualityReport}if(e.onKeylogWrite){rtclistener.config.onKeylogWrite=e.onKeylogWrite}if(e.onWebSocketReconnection){rtclistener.config.onWebSocketReconnection=e.onWebSocketReconnection}if(e.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice=e.onUserDefinedWebRTCEventNotice}rtclistener.config.onChangeRemoteStreamState=e.onChangeRemoteStreamState;return true};var i=0;var getLocalStream=function(e){try{if(global.websocket){var t=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA);global.websocket.send(JSON.stringify(t))}}catch(e){console.error("send get open camera failed! ",e)}if(global.config.isScreenShare){getStreamByScreen(e)}else{getStreamByCamera(e)}};var getStreamByCamera=function(n){if(isSafari()){if(global.constraints.video&&global.constraints.video.deviceId){global.constraints={audio:global.config.audioActive,video:{deviceId:global.constraints.video.deviceId}}}else{global.constraints={audio:global.config.audioActive,video:global.config.videoActive}}}if(!global.deviceInfo.hasAudio||!global.config.audioActive){global.constraints.audio=false}if(!global.deviceInfo.hasVideo||!global.config.videoActive){global.constraints.video=false}if(global.localStream){global.localStream.getTracks().forEach(function(e){e.stop()});global.localStream=null}navigator.mediaDevices.getUserMedia(global.constraints).then(function(e){rtcLog.info("get user media ok! global.constraints:"+JSON.stringify(global.constraints));uploadWebLog("get user media ok! global.constraints:"+JSON.stringify(global.constraints),null,global.KEY_TAG.RTC_LOG_TAG);WebRTCAPI.GLOBAL.LocalStream=global.localStream=e;var t=global.peerConnections[0];if(t){t.addStream(e)}try{if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_OK);global.websocket.send(JSON.stringify(r))}}catch(e){console.error("send get open camera suc failed! ",e)}n(0,e)}).catch(function(e){navigator.getUserMedia(global.constraints,function(e){rtcLog.info("get user media ok! global.constraints:"+JSON.stringify(global.constraints));uploadWebLog("get user media ok! global.constraints:"+JSON.stringify(global.constraints),null,global.KEY_TAG.RTC_LOG_TAG);WebRTCAPI.GLOBAL.LocalStream=global.localStream=e;var t=global.peerConnections[0];if(t){t.addStream(e)}try{if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_OK);global.websocket.send(JSON.stringify(r))}}catch(e){console.error("send get open camera suc failed! ",e)}n(0,e)},function(e){if(global.hasRetryOpenCamera){var t="get user media failed : error = "+e.message+" global.constraints:"+JSON.stringify(global.constraints);rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);n(-10008,e)}else{var t="get user media failed, error = "+e.message+" global.constraints:"+JSON.stringify(global.constraints)+" RetryOpenCamera";rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);global.constraints.video=true;global.hasRetryOpenCamera=true;getLocalStream(function(e,t){n(e,t)})}})})};var getStreamByScreen=function(a){ScreenChromeExtensionUtil.getScreenConstraints(function(e,o){$.extend(o.mandatory,{maxWidth:global.constraints.video.width.exact,maxHeight:global.constraints.video.height.exact,maxFrameRate:global.constraints.video.frameRate.exact,minFrameRate:global.constraints.video.frameRate.exact});o={audio:false,video:o};if(!global.deviceInfo.hasAudio||!global.config.audioActive){global.constraints.audio=false}if(!global.deviceInfo.hasVideo||!global.config.videoActive){global.constraints.video=false}if(global.localStream){global.localStream.getTracks().forEach(function(e){e.stop()});global.localStream=null}if(!global.constraints.audio){navigator.mediaDevices.getUserMedia(o).then(function(e){var t="get user media ok! screen_constraints:"+JSON.stringify(o);rtcLog.info(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);var r=global.peerConnections[0];if(r){r.addStream(e)}try{if(global.websocket){var n=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_OK);global.websocket.send(JSON.stringify(n))}}catch(e){console.error("send get share screen suc failed! ",e)}a(0,e)},function(e){var t="get user media failed: error = "+e.message+" screen_constraints:"+JSON.stringify(o);rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);a(-50003,e)})}else{Promise.all([navigator.mediaDevices.getUserMedia(o),navigator.mediaDevices.getUserMedia(global.constraints)]).then(function(e){var t=e[0];if(e.length>1){t.addTrack(e[1].getAudioTracks()[0])}var r="get user media ok! screen_constraints:"+JSON.stringify(o)+"; global.constraints:"+JSON.stringify(global.constraints);rtcLog.info(r);uploadWebLog(r,null,global.KEY_TAG.RTC_LOG_TAG);WebRTCAPI.GLOBAL.LocalStream=global.localStream=t;var n=global.peerConnections[0];if(n){n.addStream(t)}try{if(global.websocket){var i=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_OK);global.websocket.send(JSON.stringify(i))}}catch(e){console.error("send get share screen suc failed! ",e)}a(0,t)},function(e){var t="get user media failed : error = "+e.message+"screen_constraints"+JSON.stringify(o)+" global.constraints:"+JSON.stringify(global.constraints);rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);a(-50003,e)})}})};var updateLocalStream=function(t,c,l,d){if(global.config.isScreenShare){if(l){d(-50002,"屏幕分享不能切换摄像头或者切换spear配置~");return}if(!global.constraints.audio){return}else{global.localStream.getAudioTracks().forEach(function(e){var t=e.getConstraints();for(var r in t){for(var n in t[r]){rtcLog.info("old key:"+r+"|"+n+" value:"+t[r][n])}}e.stop();global.localStream.removeTrack(e)});navigator.mediaDevices.getUserMedia(global.constraints).then(function(e){rtcLog.info("get new user media ok!!!  newConstraints");try{if(global.websocket){var t=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_OK);global.websocket.send(JSON.stringify(t))}}catch(e){console.error("send get share screen suc failed! ",e)}var r=e.getAudioTracks();if(c&&r.length>0){global.localStream.addTrack(r[0]);var n=global.peerConnections[0];if(n){var i=n.getSenders()||[];for(var o=0,a=i.length;o<a;o++){var s=i[o];if(s.track.kind==="audio"){if(s.replaceTrack){s.replaceTrack(r[0])}else{n.removeTrack(s);n.addTrack(r[0],global.localStream)}break}}}}d(0,e)},function(e){var t="get user media failed : error = "+e.message+"screen_constraints"+JSON.stringify(screen_constraints)+" global.constraints:"+JSON.stringify(global.constraints);rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.RTC_LOG_TAG);d(-50003,e)})}}else{if(global.hasRetryOpenCamera){rtcLog.warn("update local stream : camera not support, try default constraints");return}if(l){global.localStream.getVideoTracks().forEach(function(e){var t=e.getConstraints();for(var r in t){for(var n in t[r]){rtcLog.info("old key:"+r+"|"+n+" value:"+t[r][n])}}e.stop();global.localStream.removeTrack(e)})}if(c){global.localStream.getAudioTracks().forEach(function(e){var t=e.getConstraints();for(var r in t){for(var n in t[r]){rtcLog.info("old key:"+r+"|"+n+" value:"+t[r][n])}}e.stop();global.localStream.removeTrack(e)})}try{if(global.websocket){var e=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA);global.websocket.send(JSON.stringify(e))}}catch(e){console.error("send get open camera failed! ",e)}rtcLog.info("get new user media, newConstraints",t);navigator.mediaDevices.getUserMedia(t).then(function(e){rtcLog.info("get new user media ok!!!  newConstraints");var t=e.getVideoTracks();if(l&&t.length>0){global.localStream.addTrack(t[0]);var r=global.peerConnections[0];if(r){var n=r.getSenders()||[];for(var i=0,o=n.length;i<o;i++){var a=n[i];if(a.track.kind==="video"){if(a.replaceTrack){a.replaceTrack(t[0])}else{r.removeTrack(a);r.addTrack(t[0],global.localStream)}break}}}}var s=e.getAudioTracks();if(c&&s.length>0){global.localStream.addTrack(s[0]);var r=global.peerConnections[0];if(r){var n=r.getSenders()||[];for(var i=0,o=n.length;i<o;i++){var a=n[i];if(a.track.kind==="audio"){if(a.replaceTrack){a.replaceTrack(s[0])}else{r.removeTrack(a);r.addTrack(s[0],global.localStream)}break}}}}d(0,e)}).catch(function(e){navigator.getUserMedia(t,function(e){rtcLog.info("get new user media ok!!!  newConstraints");var t=e.getVideoTracks();if(l&&t.length>0){global.localStream.addTrack(t[0]);var r=global.peerConnections[0];if(r){var n=r.getSenders()||[];for(var i=0,o=n.length;i<o;i++){var a=n[i];if(a.track.kind==="video"){if(a.replaceTrack){a.replaceTrack(t[0])}else{r.removeTrack(a);r.addTrack(t[0],global.localStream)}break}}}}var s=e.getAudioTracks();if(c&&s.length>0){global.localStream.addTrack(s[0]);var r=global.peerConnections[0];if(r){var n=r.getSenders()||[];for(var i=0,o=n.length;i<o;i++){var a=n[i];if(a.track.kind==="audio"){if(a.replaceTrack){a.replaceTrack(s[0])}else{r.removeTrack(a);r.addTrack(s[0],global.localStream)}break}}}}d(0,e)},function(e){var t="get new user media failed : error = "+e.message;rtcLog.error(t);d(-10008,e)})})}};function isSupportH264(e){var t=false;try{var r=e.split("\r\n");for(var n=0;n<r.length;n++){var i=r[n];if(i.indexOf("a=rtpmap")!==-1&&(i.indexOf("H264/")!==-1||i.indexOf("h264/")!==-1)){t=true;break}}}catch(e){console.log(e)}return t}var getSdp=function(n,i){if(!n){n=0}var o=global.peerConnections[n];var e=global.offerSdpOption;o.createOffer(e).then(function(e){if(isSupportH264(e.sdp)){return o.setLocalDescription(e)}else{if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.H264_NOT_SUPPORT)}var t="this web browser do not support h264. srctinyid = "+n;rtcLog.error(t);uploadWebLog(t,null,global.KEY_TAG.SDP_TAG);try{if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_NOT_SUPPORT_H264);global.websocket.send(JSON.stringify(r))}}catch(e){console.error("error : ",e.message)}i(-10009,t)}}).then(function(){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.GET_LOCAL_SDP_SUC,null)}var e=o.localDescription;rtcLog.info("get local sdp info : "+e.sdp);i(0,e)}).catch(function(e){rtcLog.error("create offer failed : reason = "+e);i(-10009,e)})};var clearGlobalValues=function(){global.config={sdkAppId:"",openid:"",tinyid:"",srctinyid:"",userSig:"",accountType:""};global.constraints={audio:true,video:true};global.deviceInfo={audio:false,video:false};global.checkSigSeq=null;global.reportTime=0;global.specifyConstraints=null;global.hasRetryOpenCamera=false};var createPeerConnection=function(t){rtcLog.debug("createPeerConnection with srctinyid:"+t);var e={iceServers:[{urls:global.WEBRTC_STUN_SERVER}],bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};var r={optional:[{DtlsSrtpKeyAgreement:true}]};try{var n=new RTCPeerConnection(e,r);n.localCandidateList=[];n.isSdpSendOK=false;n.hasSendCandidate=false;n.videoStreams={};global.peerConnections[t]=n;n.onicecandidate=function(e){onIceCandidate(e,t)};n.onaddstream=function(e){rtcLog.info("peerConnection.onaddstream:"+e.stream.id)};n.oniceconnectionstatechange=function(e){onIceConnectionStateChange(e,t)};n.ontrack=function(e){rtcLog.info("peerConnection.ontrack: streams.length="+e.streams.length);onAddTrack(e.streams[0],e.track.kind,t)};n.onremovestream=function(e){rtcLog.info("peerConnection.onremovestream:"+e.stream.id);onRemoveStream(e.stream,t)};n.onsignalingstatechange=function(e){rtcLog.info("peerConnection.onsignalingstatechange:"+n.signalingState)};n.onicegatheringstatechange=function(e){rtcLog.info("peerConnection.onicegatheringstatechange : "+e.target.iceGatheringState);if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.ON_ICE_GATHERING_STATE_CHANGE,e.target.iceGatheringState)}};n.onnegotiationneeded=function(e){rtcLog.info("peerConnection.onnegotiationneeded")};if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.CREATE_PC_SUC,null)}}catch(e){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.CREATE_PC_FAILED,null)}var i="create peer connection failed!!! exception : "+e;rtcLog.error(i);if(global.websocket){var o=createJsonFromTag(global.RTC_EVENT.ON_CREATE_PEERCONNECTION_FAILED);o.data=i;global.websocket.send(JSON.stringify(o))}return false}return true};var wsonopen=function(){uploadWebLog("web socket init success",null,global.KEY_TAG.WEBSOCKET_TAG);rtcLog.info("web socket init success")};var setConstraints=function(e,t){if(e){rtcLog.info("videoCtrlAbility.length="+e.length);if(e.length>0){var r=t&&t.VidWidth||e[0].VidWidth;var n=t&&t&&t.VidHeight||e[0].VidHeight;var i=t&&t&&t.VidFr||e[0].VidFr;var o=e[0].CpuOverUseDetect;if(r>0&&n>0&&i>0){global.constraints={audio:true,video:{width:{exact:r},height:{exact:n},frameRate:{exact:i},googCpuOveruseDetection:o?true:false}}}}if(t&&t.audio&&t.audio.deviceId){if(typeof global.constraints.audio==="object"){global.constraints.audio.deviceId=t.audio.deviceId}else{global.constraints.audio={deviceId:t.audio.deviceId}}}if(t&&t.video&&t.video.deviceId){if(typeof global.constraints.video==="object"){global.constraints.video.deviceId=t.video.deviceId}else{global.constraints.video.deviceId=t.video.deviceId}}}console.debug(global.constraints)};var wsonneedreconnect=function(e){if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_OPEN){if(global.websocket){global.websocket.reconnect()}}else{if(rtclistener.config.onWebSocketReconnection){rtclistener.config.onWebSocketReconnection()}}};function startQualityReport(){global.reportSto=setInterval(reportQuality,2e3)}var wsonmessage=function(e){var t=e.data;var r=JSON.parse(t);var n=r.cmd;rtcLog.info("on websocket message, cmd = "+n);var i="RECV_CMD_FROM_SIGNAL";uploadWebLog("WebRTCJSAPI receive cmd from signal server : cmd = "+n,null,i);if(n===global.WS_CMD.CANDIDATE){uploadWebLog("WebRTCJSAPI receive remote candidate from siganl server, srctinyid = "+r.srctinyid,null,i);onRemoteCandidate(r.content,r.srctinyid)}else if(n===global.WS_CMD.SDP){uploadWebLog("WebRTCJSAPI receive remote sdp from siganl server, srctinyid = "+r.srctinyid,null,i);onRemoteSdp(r.content,r.srctinyid)}else if(n===global.WS_CMD.MEDIA_CHANGE){uploadWebLog("WebRTCJSAPI receive media change from siganl server",null,i);onMediaChange(r.content)}else if(n===global.WS_CMD.QUIT_CHAT){uploadWebLog("WebRTCJSAPI receive quit chat from siganl server, info = "+JSON.stringify(r),null,i);onQuitChat(r.content)}else if(n===global.WS_CMD.WS_INIT_OK){global.websocket.socketid=r.content.socketid;global.relayip=r.content.relayip;global.localip=r.content.localip;global.signalip=r.content.signalip;global.dataport=r.content.dataport;global.stunport=r.content.stunport;global.localip=r.content.localip;global.checkSigSeq=r.content.checkSigSeq;global.stunportList=r.content.stunportList;if(!global.stunportList||global.stunportList.length<=0){global.WEBRTC_STUN_SERVER="stun:"+global.relayip+":"+global.stunport}else{var o=[];for(var a=0;a<global.stunportList.length;a++){var s=global.stunportList[a];var c="stun:"+global.relayip+":"+s;o.push(c)}global.WEBRTC_STUN_SERVER=o}if(r.content.cgiurl){global.WEBRTC_CGI_URL=r.content.cgiurl}rtcLog.info("WS_INIT_OK : data = "+JSON.stringify(r.content)+" , stun server = "+global.WEBRTC_STUN_SERVER);global.websocket.relayInfo.stunport=global.stunport;global.websocket.relayInfo.outterip=global.relayip;global.websocket.relayInfo.dataport=global.dataport;global.websocket.relayInfo.innerip=r.content.innerip;global.websocket.sessioninfo.openid=r.content.openid;global.websocket.sessioninfo.tinyid=r.content.tinyid;global.config.tinyid=r.content.tinyid;global.config.openid=r.content.openid;var l=r.content.rc;uploadWebLog("WebRTCJSAPI receive websocket init from siganl server, info = "+JSON.stringify(r.content),null,i);if(l===1){console.info("reconnect ok, now rebuild session!");var d=rebuildSession();if(!d){try{global.websocket.close();global.websocket=null}catch(e){console.error(e)}rtclistener.config.onWebSocketInit({result:-11001,error:"1.请确认已经开通白名单 / 2.请确认签名正确且有效"})}return}if(l!==1){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.WEBSOCKET_INIT_OK,null)}rtclistener.config.onWebSocketInit({result:0,openid:r.content.openid,tinyid:r.content.tinyid,relayip:global.relayip,innerip:r.content.innerip})}}else if(n===global.WS_CMD.WS_INIT_FAILED){rtcLog.error("ws init failed !!!  ");uploadWebLog("WebRTCJSAPI receive websocket init failed from siganl server",null,i);try{global.websocket.close();global.websocket=null}catch(e){console.error(e)}rtclistener.config.onWebSocketInit({result:-11e3,error:"1.请确认已经开通白名单 / 2.请确认签名正确且有效"})}else if(n===global.WS_CMD.CREATE_ROOM_RESULT){var u=r.content;uploadWebLog("WebRTCJSAPI receive create room result from siganl server, info = "+JSON.stringify(u),null,i);if(u.ret!==0){rtcLog.error("create room error!!! e = "+u.error);try{global.websocket.close();global.websocket=null}catch(e){console.error(e)}rtclistener.config.onCreateRoomResult(u.ret);return}global.roomid=u.data.roomid;global.config.tinyid=u.data.tinyid;global.config.srctinyid=u.data.srctinyid;global.openIdMap[u.data.tinyid]=u.data.openid;global.websocket.sessioninfo.sessionid=global.roomid;global.websocket.hasConnect=true;initEndReport(global.ostype,global.ostype,global.relayip,global.localip,global.config.tinyid,global.roomid,global.cpunum,global.cpuname);if(u.data.videoability&&global.specifyConstraints){setConstraints(u.data.videoability,global.specifyConstraints)}else{setConstraints(u.data.videoability)}console.debug("global.constraints",global.constraints);rtcLog.info("create room ok!!! data = "+JSON.stringify(u.data));rtclistener.config.onCreateRoomResult(0);global.reportTime=(new Date).valueOf();rtcLog.info("start quality report : time = "+global.reportTime);startQualityReport();if(global.config.closeLocalMedia){return}webrtc.startWebRTC(startWebRTCCalllback)}else if(n===global.WS_CMD.NOTIFY_CREATE_PEER_CONNECTION){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.RECEIVE_CREATE_PEER,null)}var u=r.content;uploadWebLog("WebRTCJSAPI receive create peerconnection from siganl server, info = "+JSON.stringify(u),null,i);addPeer(u.openid,u.tinyid,global.roomid,u.srctinyid,u.userSig,u.peerconnectionport)}else if(n===global.WS_CMD.NOTIFY_CREATE_PEER_CONNECTION_RES){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.BEGIN_CREATE_PEER,null)}var u=r.content;uploadWebLog("WebRTCJSAPI receive create peerconnection res from siganl server, info = "+JSON.stringify(u),null,i);if(u.data.videoability){setConstraints(u.data.videoability)}rtcLog.debug("add peer ok!!! data = "+JSON.stringify(u.data));if(u.data.srcopenid){global.openIdMap[u.data.srctinyid]=u.data.srcopenid}webrtc.startWebRTC(startWebRTCCalllback,u.data.srctinyid)}else if(n===global.WS_CMD.NOTIFY_CLOSE_PEER_CONNECTION){var u=r.content;uploadWebLog("WebRTCJSAPI receive close peerconnection from siganl server, info = "+JSON.stringify(u),null,i);onClosePeerConnections(u)}else if(n===global.WS_CMD.NOTIFY_CHANGE_CONSTRAINTS){var u=r.content;uploadWebLog("WebRTCJSAPI receive change constraints from siganl server",null,i);var f={audio:global.constraints.audio,video:{width:{exact:parseInt(u.width)},height:{exact:parseInt(u.height)},frameRate:{exact:parseInt(u.frameRate)}}};if(global.constraints.video.deviceId){f.video.deviceId=global.constraints.video.deviceId}onChangeConstraints(f,false,true)}else if(n===global.WS_CMD.NOTIFY_SUB_VIDEO_STATE){var u=r.content;uploadWebLog("WebRTCJSAPI receive notify sub video state from siganl server",null,i);onSubVideoState(u)}else if(n===global.WS_CMD.NOTIFY_UPDATE_AUDIO_SSRC){var u=r.content;uploadWebLog("WebRTCJSAPI receive update audio ssrc from siganl server",null,i);onUpdateAudSsrc(u)}else if(n===global.WS_CMD.NOTIFY_UPDATE_VIDEO_SSRC){var u=r.content;uploadWebLog("WebRTCJSAPI receive update video ssrc from siganl server",null,i);onUpdateVidSsrc(u)}else if(n===global.WS_CMD.NOTIFY_MAX_TIMEMS){var u=r.content;if(onGetMaxTimeMs){onGetMaxTimeMs({maxAudTimeMs:u.maxAudTimeMs,maxVidTimeMs:u.maxVidTimeMs})}}else if(n===global.WS_CMD.NOTIFY_RECONNECT_DC){var u=r.content;uploadWebLog("WebRTCJSAPI receive NOTIFY_RECONNECT_DC from siganl server",null,i);webrtc.recreateDataChannel()}};function rebuildSession(){try{console.log("begin rebuild session!!!  size = "+global.websocket.sessioninfo.srcids.length);var e=createJsonFromTag(global.RTC_EVENT.ON_REBUILD_SESSION);e.data={socketid:global.websocket.socketid,tinyid:global.websocket.sessioninfo.tinyid,appid:global.config.sdkAppId,openid:global.websocket.sessioninfo.openid,sessionid:global.websocket.sessioninfo.sessionid,sids:global.websocket.sessioninfo.srcids,relayInfo:global.websocket.relayInfo.innerip,remotesdp:global.websocket.sessioninfo.peersdp};global.websocket.send(JSON.stringify(e));return true}catch(e){console.error("rebuild session exception : ",e);return false}}var wsonclose=function(e){var t="websocket close! , code = "+e.code;uploadWebLog(t,null,"WEBSOCKET");rtcLog.warn(t);switch(e.code){case 1e3:break;case 1006:rtcLog.error("Websocket close! Network is broken!");uploadWebLog("Websocket close!!! network is broken",null,"WEBSOCKET");if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.ON_WEBSOCKET_CLOSE_BY_NETWORK_BROKEN,null)}break;default:break}if(rtclistener.config.onWSClose){rtclistener.config.onWSClose()}};var filterIceCandidate=function(e){var t=e.candidate;if(t.indexOf("tcp")!==-1){return false}var r=getIceCandidateType(e);if(r!=="srflx"){return false}return true};var getIceCandidateType=function(e){try{var t=e.candidate;var r=t.split(" ");return r[7]}catch(e){rtcLog.error("Get Ice Candidate Type Error : e = "+e);return null}};var onIceCandidate=function(e,t){var r=global.peerConnections[t];var n=e.candidate;if(!n){rtcLog.debug("Ice Candidate End!");if(r.localCandidateList.length<=0){rtcLog.error("get local candidate failed!");if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.GET_LOCAL_STUN_IP_FAILED,null)}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.GET_STUN_IP_FAILED)}if(global.websocket){var i=createJsonFromTag(global.RTC_EVENT.ON_GET_LOCAL_CANDIDATE_FAILED);i.data={stunserver:global.WEBRTC_STUN_SERVER};global.websocket.send(JSON.stringify(i))}return}if(r.isSdpSendOK&&!r.hasSendCandidate){rtcLog.info("send candidate when ice end!");r.hasSendCandidate=true;var o=r.localCandidateList.length;var a=r.localCandidateList[o-1];sendLocalCandidate(a,t)}return}rtcLog.info("on ice candidate : sdpMLineIndex = "+n.sdpMLineIndex+" , sdpMid = "+n.sdpMid+" , candidate = "+n.candidate);if(filterIceCandidate(n)){var s={sdpMLineIndex:n.sdpMLineIndex,sdpMid:n.sdpMid,candidate:n.candidate};r.localCandidateList.push(s);if(r.localCandidateList.length>0&&r.isSdpSendOK){r.hasSendCandidate=true;sendLocalCandidate(r.localCandidateList[r.localCandidateList.length-1],t)}}else{rtcLog.warn("filterIceCandidate failed","Only UDP protocol is supported [ it is just an ability-check , doesn't mean u can not connect ,wait for next ice callback]",n.candidate)}};var onAddTrack=function(e,t,r){rtcLog.info("onAddTrack, srctinyid:"+r+"stream.getVideoTracks().length="+e.getVideoTracks().length+"stream.getAudioTracks().length="+e.getAudioTracks().length);if(r=="1"){rtcLog.info("onAddTrack, srctinyid:"+r+", data channel, not show video!");return}if(r!="0"){var n=global.peerConnections[r];if(n){var i=n.remoteDescription.sdp;var o=i.split("a=mid:audio");var a;if(o.length>1){a=o[1].split("a=mid:video")}else{a=o[0].split("a=mid:video")}var s=[];var c=[];for(var l=0;l<a.length;l++){var d=a[l].split("\r\n");var u=d.length;var f;for(var p=0;p<u;p++){if(l===0){if(d[p].indexOf("a=ssrc:")===0){f=parseInt(d[p].split(" ")[0].split(":")[1]);if(!s.includes(f)){s.push(f)}}}else{if(d[p].indexOf("a=ssrc-group:")===0){f=parseInt(d[p].split(" ")[1]);if(!c.includes(f)){c.push(f)}}}}}var g={video:{},audio:[]};var v;for(v in s){g.audio.push(s[v]>>16&255)}var m,_;for(v in c){m=c[v]>>16&255;if(m===global.STREAM_TYPE.MAIN){_=r+"_"+global.STREAM_MISD.MAIN}else if(m===global.STREAM_TYPE.AID){_=r+"_"+global.STREAM_MISD.AID}g.video[_]=m}var b=r+"_"+e.id;rtcLog.info("onAddTrack, videoId:"+b);n.videoStreams[b]=e;var h=webrtc.getOpenId(r);rtclistener.config.onRemoteStreamUpdate({stream:e,videoId:b,type:t,SsrcState:g,openId:h})}}};var onIceConnectionStateChange=function(e,t){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.ON_ICE_STATE_CHANGE,e.target.iceConnectionState)}rtcLog.info("on ice connection state change : iceConnectionState = "+e.target.iceConnectionState+" , iceGatheringState = "+e.target.iceGatheringState+" srctinyid = "+t);if("completed"===e.target.iceConnectionState&&"completed"===e.target.iceGatheringState){if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_ICE_COMPLETE);global.websocket.send(JSON.stringify(r))}}if(e.target.iceConnectionState==="failed"||e.target.iceGatheringState==="failed"||e.target.iceConnectionState==="disconnected"||e.target.iceGatheringState==="disconnected"){if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_ICE_BROKEN);r.data={iceConnectionState:e.target.iceConnectionState,iceGatheringState:e.target.iceGatheringState,openid:global.config.openid,tinyid:global.config.tinyid,srctinyid:t};global.websocket.send(JSON.stringify(r))}}else if(e.target.iceConnectionState==="closed"||e.target.iceGatheringState==="closed"){rtclistener.config.onIceConnectionClose()}};var onRemoveStream=function(e,t){rtcLog.info("on remove stream : srctinyid = "+t);var r=global.peerConnections[t];if(r){var n=t+"_"+e.id;rtclistener.config.onPeerStreamRemove(n)}};var onClosePeerConnections=function(e){rtcLog.info("onClosePeerConnections : srctinyid = "+e.srctinyid);global.websocket.sessioninfo.peersdp[e.srctinyid+""]=null;for(var t=0;t<global.websocket.sessioninfo.srcids.length;t++){if(global.websocket.sessioninfo.srcids[t]==e.srctinyid){global.websocket.sessioninfo.srcids.splice(t,1);break}}var r=global.peerConnections[e.srctinyid];if(r){for(var n in r.videoStreams){rtcLog.info("onClosePeerConnections: videoId = "+n);rtclistener.config.onPeerStreamRemove(n)}if(r.signalingState!=="closed"){r.close()}r=null;delete global.peerConnections[e.srctinyid]}};var onChangeConstraints=function(e,r,n){rtcLog.info("on change constraints newConstraints: "+JSON.stringify(e));var i=0;updateLocalStream(e,r,n,function(e,t){if(e===0){n&&t.getVideoTracks().forEach(function(e){var t=e.getConstraints();for(var r in t){for(var n in t[r]){rtcLog.info("new key:"+r+"|"+n+" value:"+t[r][n])}}});r&&t.getAudioTracks().forEach(function(e){var t=e.getConstraints();for(var r in t){for(var n in t[r]){rtcLog.info("new key:"+r+"|"+n+" value:"+t[r][n])}}})}rtclistener.config.onLocalStreamAdd(global.localStream);getSdp(i,function(e,t){if(e!==0){rtcLog.error("get local sdp failed!!! e = "+t);callback(e);return}rtcLog.info("get new local sdp success!");sendUpdateSdp(t,i)})})};var updateRemoteSdp=function(e,t){if(parseInt(e||0)==0){var r="Receive update remote sdp, but srctinyid = 0!!!";uploadWebLog(r,null,"UPDATE_REMOTE_SDP");return}var n=global.peerConnections[e];if(!n){var r="onUpdateRemoteSdp, failed to get peerconnection. srctinyid = "+e;rtcLog.error(r);uploadWebLog(r,null,"UPDATE_REMOTE_SDP");if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_SDP_FAILED,null)}return}rtcLog.info("onUpdateRemoteSdp peerConnection.localDescription:"+n.localDescription.sdp+"\r\n"+n.localDescription.type);rtcLog.info("onUpdateRemoteSdp peerConnection.remoteDescription:"+n.remoteDescription.sdp+"\r\n"+n.remoteDescription.type);rtcLog.info("onUpdateRemoteSdp new sdp :"+t.sdp+"\r\n"+t.type);n.setRemoteDescription(new RTCSessionDescription(t),function(){if(e!=0){global.websocket.sessioninfo.peersdp[e+""]=t.sdp}rtcLog.info("onUpdateRemoteSdp setRemoteDescription success!")},function(){rtcLog.info("onUpdateRemoteSdp setRemoteDescription failed!")})};var onSubVideoState=function(e){rtcLog.info("onSubVideoState");if(parseInt(e.srctinyid||0)==0)return;var t=e.state;var r=parseInt(e.localSubVidSsrc);var n=r>>16&255;var i;if(n===global.STREAM_TYPE.MAIN){i=e.srctinyid+"_"+global.STREAM_MISD.MAIN}else{i=e.srctinyid+"_"+global.STREAM_MISD.AID}var o={type:n,state:t,videoId:i};rtclistener.config.onChangeRemoteStreamState(o);var a=global.peerConnections[e.srctinyid];if(!a){var s="onSubVideoState, failed to get peerconnection. srctinyid = "+srctinyid;rtcLog.error(s);return}e.newSdp.type="pranswer";updateRemoteSdp(e.srctinyid,e.newSdp)};var onUpdateAudSsrc=function(e){rtcLog.info("onUpdateAudSsrc");if(parseInt(e.srctinyid||0)==0)return;var t=global.peerConnections[e.srctinyid];if(!t){var r="onUpdateAudSsrc, failed to get peerconnection. srctinyid = "+srctinyid;rtcLog.error(r);return}e.newSdp.type="pranswer";updateRemoteSdp(e.srctinyid,e.newSdp)};var onUpdateVidSsrc=function(e){rtcLog.info("onUpdateVidSsrc:\r\n "+JSON.stringify(e));if(parseInt(e.srctinyid||0)==0)return;var t=global.peerConnections[e.srctinyid];if(!t){var r="onUpdateVidSsrc, failed to get peerconnection. srctinyid = "+srctinyid;rtcLog.error(r);return}e.newSdp.type="pranswer";updateRemoteSdp(e.srctinyid,e.newSdp)};var onGetMaxTimeMs=function(e){rtcLog.info("onGetMaxTimeMs: "+JSON.stringify(e))};var onRemoteCandidate=function(e,t){rtcLog.info("on peer candidate : remote candidate = "+JSON.stringify(e)+" ,srctinyid "+t);t=global.config.tinyid===t?0:t;var r=global.peerConnections[t||0];if(!r){var n="on remote candidate , failed to get peerconnection. srctinyid = "+t;rtcLog.error(n);if(global.websocket){var i=createJsonFromTag(global.RTC_EVENT.ON_GET_SRC_PEER_CONNECTION_FAILED);i.data=n;global.websocket.send(JSON.stringify(i))}if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_CANDIDATE_FAILED,null)}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.CANDIDATE_FAILED)}return}r.addIceCandidate(e,function(){rtcLog.info("add ice candidate ok");if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_CANDIDATE_SUC,null)}rtcLog.warn("push src tiny id in src list, tinyid = "+global.config.tinyid+" , src tinyid = "+t);global.websocket.sessioninfo.srcids.push(t+"");if(global.websocket){var e=createJsonFromTag(global.RTC_EVENT.ON_SET_REMOTE_CANDIDATE_SUC);global.websocket.send(JSON.stringify(e))}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(true,ICE_BUILD_STATE.SUC)}},function(e){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_CANDIDATE_FAILED,null)}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.CANDIDATE_FAILED)}var t="add remote candidate failed!  exception = "+e;rtcLog.error(t);if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_SET_REMOTE_CANDIDATE_FAILED);r.data={errorMsg:t,openid:global.config.openid,tinyid:global.config.tinyid,sessionid:global.roomid};global.websocket.send(JSON.stringify(r))}})};var sendLocalCandidate=function(e,t){if(e){var r=createJsonFromTag(global.RTC_EVENT.ON_PEER_CANDIDATE);r.data=e;r.srctinyid=t||"0";global.websocket.send(JSON.stringify(r))}};var onRemoteSdp=function(t,r){rtcLog.info("srctinyid:"+r+"on anwser sdp : "+t.sdp);r=global.config.tinyid===r?0:r;var n=global.peerConnections[r];if(!n){var e="on remote sdp , failed to get peerconnection. srctinyid = "+r;rtcLog.error(e);if(global.websocket){var i=createJsonFromTag(global.RTC_EVENT.ON_GET_SRC_PEER_CONNECTION_FAILED);i.data=e;global.websocket.send(JSON.stringify(i))}if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_SDP_FAILED,null)}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.SDP_FAILED)}return}if(r!=0){t.type="pranswer"}n.setRemoteDescription(new RTCSessionDescription(t),function(){if(n.localCandidateList.length>0&&!n.hasSendCandidate){n.hasSendCandidate=true;sendLocalCandidate(n.localCandidateList[n.localCandidateList.length-1],r)}if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_SDP_SUC,null)}if(r!=0){global.websocket.sessioninfo.peersdp[r+""]=t.sdp}n.isSdpSendOK=true;if(global.websocket){var e=createJsonFromTag(global.RTC_EVENT.ON_SET_REMOTE_SDP_SUC);global.websocket.send(JSON.stringify(e))}},function(e){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.SET_REMOTE_SDP_FAILED,null)}if(rtclistener.config.onIceConnectionBuild){rtclistener.config.onIceConnectionBuild(false,ICE_BUILD_STATE.SDP_FAILED)}try{var t="on set remote sdp failed , exception = "+e.message;if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_SET_REMOTE_SDP_FAILED);r.data={errorMsg:t,tinyid:global.config.tinyid,openid:global.config.openid,sessionid:global.roomid};global.websocket.send(JSON.stringify(r))}rtcLog.error(t)}catch(e){console.log(e)}})};var onMediaChange=function(e){};var onQuitChat=function(e){rtcLog.debug("onQuitChat , call onRelayTimeout");webrtc.quit();if(e.type==="kick"){rtclistener.config.onKickout(e)}else{rtclistener.config.onRelayTimeout(e)}};var openRoom=function(e,t,r,n,i,o){rtcLog.debug("open room : openid = "+e+" , tinyid = "+t+" ,  roomid = "+r);var a=createJsonFromTag(global.RTC_EVENT.ON_CREATE_ROOM);a.data={openid:e,tinyid:t,peerconnectionport:o,roomid:String(r),sdkAppID:String(global.config.sdkAppId),socketid:global.websocket.socketid,userSig:i||global.config.userSig,relayip:global.websocket.relayInfo.innerip,dataport:global.dataport,stunport:global.stunport,checkSigSeq:global.checkSigSeq,role:n};var s=WebRTCStat.ability(global.constraints);global.ostype=s.AbilityOption.GeneralLimit.str_os_verion;global.cpunum=parseInt(s.AbilityOption.GeneralLimit.CPULimit.uint32_CPU_num);global.cpuname=s.AbilityOption.GeneralLimit.CPULimit.str_CPU_name;a.report=s||null;global.websocket.send(JSON.stringify(a));return true};var addPeer=function(e,t,r,n,i,o){var a={openid:e,tinyid:t,srctinyid:n,peerconnectionport:o,roomid:r,sdkAppID:String(global.config.sdkAppId),socketid:global.websocket.socketid,userSig:i||global.config.userSig,relayip:global.websocket.relayInfo.innerip,dataport:global.dataport,stunport:global.stunport};rtcLog.debug("add peer : openid = "+JSON.stringify(a));var s=createJsonFromTag(global.RTC_EVENT.ON_CREATE_PEER);s.data=a;global.websocket.send(JSON.stringify(s));return true};function parseFinalReport(e,t){t=t||false;e.WebRTCQualityReq.uint64_end_utime=(new Date).getTime();if(!global.preReportData){global.preReportData=cloneObj(e);e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br=e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br*8/2;e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br=e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br*8/2;if(t){e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br=e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br*8/2}var r=e.WebRTCQualityReq.VideoReportState.VideoDecState.length;for(var n=0;n<r;n++){e.WebRTCQualityReq.VideoReportState.VideoDecState[n].uint32_video_recv_br=e.WebRTCQualityReq.VideoReportState.VideoDecState[n].uint32_video_recv_br*8/2}e.WebRTCQualityReq.uint32_total_send_bps=e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br+e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br;return e}else{var i=cloneObj(e);e.WebRTCQualityReq.uint64_begine_utime=global.preReportData.WebRTCQualityReq.uint64_end_utime;e.WebRTCQualityReq.uint32_real_num-=global.preReportData.WebRTCQualityReq.uint32_real_num;if(e.WebRTCQualityReq.uint32_real_num<=0){e.WebRTCQualityReq.uint32_real_num=0}e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg-=global.preReportData.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg;if(e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg<=0){e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg=0}e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br-=global.preReportData.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br;if(e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br<=0){e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br=0}e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br=e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br*8/2;if(t){e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br-=global.preReportData.WebRTCQualityReq.VideoReportState.uint32_video_snd_br;if(e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br<=0){e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br=0}e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br=e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br*8/2}e.WebRTCQualityReq.AudioReportState.uint32_audio_flow-=global.preReportData.WebRTCQualityReq.AudioReportState.uint32_audio_flow;if(e.WebRTCQualityReq.AudioReportState.uint32_audio_flow<=0){e.WebRTCQualityReq.AudioReportState.uint32_audio_flow=0}e.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg-=global.preReportData.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg;if(e.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg<=0){e.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg=0}e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br-=global.preReportData.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br;if(e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br<=0){e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br=0}e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br=e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br*8/2;e.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg-=global.preReportData.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg;if(e.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg<=0){e.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg=0}var o=e.WebRTCQualityReq.VideoReportState.VideoDecState.length;for(var n=0;n<o;n++){var a=e.WebRTCQualityReq.VideoReportState.VideoDecState[n];var s=a.uint64_sender_uin;var c=a.uint32_video_real_recv_pkg;var l=a.uint32_video_recv_br;for(var d=0;d<global.preReportData.WebRTCQualityReq.VideoReportState.VideoDecState.length;d++){var u=global.preReportData.WebRTCQualityReq.VideoReportState.VideoDecState[d];if(u.uint64_sender_uin===s){c-=u.uint32_video_real_recv_pkg;if(c<=0){c=0}l-=u.uint32_video_recv_br;if(l<=0){l=0}break}}e.WebRTCQualityReq.VideoReportState.VideoDecState[n].uint32_video_real_recv_pkg=c;e.WebRTCQualityReq.VideoReportState.VideoDecState[n].uint32_video_recv_br=l*8/2}o=e.WebRTCQualityReq.AudioReportState.AudioDecState.length;for(var n=0;n<o;n++){var f=e.WebRTCQualityReq.AudioReportState.AudioDecState[n];var p=f.uint32_audio_real_recv_pkg;var g=f.uint32_audio_flow;var s=f.uint64_sender_uin;for(var v=0;v<global.preReportData.WebRTCQualityReq.AudioReportState.AudioDecState.length;v++){var m=global.preReportData.WebRTCQualityReq.AudioReportState.AudioDecState[v];if(m.uint64_sender_uin===s){p-=m.uint32_audio_real_recv_pkg;if(p<=0){p=0}g-=m.uint32_audio_flow;if(g<=0){g=0}break}}e.WebRTCQualityReq.AudioReportState.AudioDecState[n].uint32_audio_real_recv_pkg=p;e.WebRTCQualityReq.AudioReportState.AudioDecState[n].uint32_audio_flow=g;e.WebRTCQualityReq.AudioReportState.AudioDecState[n].uint32_audio_real_recv_br=g*8/2}e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_br=e.WebRTCQualityReq.AudioReportState.uint32_audio_flow*8/2;e.WebRTCQualityReq.uint32_real_num=e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg+e.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg;e.WebRTCQualityReq.uint32_total_send_bps=e.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br+e.WebRTCQualityReq.VideoReportState.uint32_video_snd_br;e.WebRTCQualityReq.uint32_total_recv_bps=e.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_br+e.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br;global.preReportData=i;return e}}function handleTotalReportData(e){var t=0;if(navigator&&navigator.cpuMaxFrequency){t=navigator.cpuMaxFrequency}var r=0;if(WebRTCAPI.GLOBAL.LocalStream){var n=WebRTCAPI.GLOBAL.LocalStream.getAudioTracks();if(n&&n[0]&&n[0].muted){r=3}else{r=1}}var o={WebRTCQualityReq:{uint64_begine_utime:(new Date).getTime(),uint64_end_utime:0,uint32_real_num:0,uint32_delay:0,uint32_CPU_curfreq:t,uint32_total_send_bps:0,uint32_total_recv_bps:0,AudioReportState:{uint32_audio_enc_pkg_br:0,uint32_audio_real_recv_pkg:0,uint32_audio_flow:0,uint32_audio_real_recv_br:0,uint32_audio_delay:0,uint32_audio_jitter:0,uint32_microphone_status:r,AudioDecState:[]},VideoReportState:{uint32_video_delay:0,uint32_video_snd_br:0,uint32_video_total_real_recv_pkg:0,uint32_video_rcv_br:0,uint32_send_total_pkg:0,VideoEncState:[{uint32_enc_width:0,uint32_enc_height:0,uint32_capture_fps:0,uint32_enc_fps:0}],VideoDecState:[]}}};for(var a in e){var i=e[a];if(a===0||a==="0"){i.forEach(function(e){var t=e["id"];var r=e["mediaType"];if(t.indexOf("ssrc")!==-1&&t.indexOf("send")!==-1){if(r==="video"){o.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg=parseInt(e["packetsSent"]||0);o.WebRTCQualityReq.VideoReportState.VideoEncState[0].uint32_capture_fps=parseInt(e["googFrameRateInput"]||0);o.WebRTCQualityReq.VideoReportState.VideoEncState[0].uint32_enc_fps=parseInt(e["googFrameRateSent"]||0);o.WebRTCQualityReq.VideoReportState.VideoEncState[0].uint32_enc_width=parseInt(e["googFrameWidthSent"]||0);o.WebRTCQualityReq.VideoReportState.VideoEncState[0].uint32_enc_height=parseInt(e["googFrameHeightSent"]||0)}else{o.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br=parseInt(e["bytesSent"]||0)}}if(t.indexOf("bweforvideo")!==-1){var n=e["googTransmitBitrate"];o.WebRTCQualityReq.VideoReportState.uint32_video_snd_br=parseInt(n||0)}if(t.indexOf("Conn-audio-1-0")!==-1){o.WebRTCQualityReq.uint32_delay=parseInt(e["googRtt"]||0)}})}else{i.forEach(function(e){var t=e["id"];var r=e["mediaType"];if(t.indexOf("ssrc")!==-1&&t.indexOf("recv")!==-1){if(r==="video"){o.WebRTCQualityReq.VideoReportState.uint32_video_delay=parseInt(e["googTargetDelayMs"]||0);o.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg+=parseInt(e["packetsReceived"]||0);o.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br+=parseInt(e["bytesReceived"]||0);var n={uint32_video_recv_fps:0,uint32_video_recv_br:0,uint32_video_real_recv_pkg:0,uint32_dec_height:0,uint32_dec_width:0,uint32_video_jitter:0,uint64_sender_uin:""};n.uint32_dec_height=parseInt(e["googFrameHeightReceived"]||0);n.uint32_dec_width=parseInt(e["googFrameWidthReceived"]||0);n.uint32_video_real_recv_pkg=parseInt(e["packetsReceived"]||0);n.uint32_video_recv_fps=parseInt(e["googFrameRateReceived"]||0);n.uint32_video_recv_br=parseInt(e["bytesReceived"]||0);n.uint32_video_jitter=parseInt(e["googJitterBufferMs"]||0);n.uint64_sender_uin=a;o.WebRTCQualityReq.VideoReportState.VideoDecState.push(n)}else{o.WebRTCQualityReq.AudioReportState.uint32_audio_delay=parseInt(e["googCurrentDelayMs"]||0);o.WebRTCQualityReq.AudioReportState.uint32_audio_jitter=parseInt(e["googJitterBufferMs"]||0);o.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg+=parseInt(e["packetsReceived"]||0);o.WebRTCQualityReq.AudioReportState.uint32_audio_flow+=parseInt(e["bytesReceived"]||0);o.WebRTCQualityReq.uint32_real_num+=parseInt(e["packetsReceived"]||0);var i={uint32_audio_delay:0,uint32_audio_jitter:0,uint32_audio_real_recv_pkg:0,uint32_audio_flow:0,uint32_audio_real_recv_br:0,uint64_sender_uin:""};i.uint32_audio_flow=parseInt(e["bytesReceived"]||0);i.uint32_audio_delay=parseInt(e["googCurrentDelayMs"]||0);i.uint32_audio_real_recv_pkg=parseInt(e["packetsReceived"]||0);i.uint32_audio_jitter=parseInt(e["googJitterBufferMs"]||0);i.uint64_sender_uin=a;o.WebRTCQualityReq.AudioReportState.AudioDecState.push(i)}}})}}return parseFinalReport(o)}function getQulityAsync(t,c){var l=Object.keys(t).length;var d=0;if(l===0){rtcLog.warn("get quality async failed! peerconnection size is 0!");c(false,null);return}var u={};for(var e in t){(function(s){var e=t[s];e.getStats(function(e){var t=e.result();var r=[];for(var n=0;n<t.length;n++){var i=t[n];var o={};i.names().forEach(function(e){o[e]=i.stat(e)});o.id=i.id;o.type=i.type;o.timestamp=i.timestamp;r.push(o)}u[s]=r;d++;if(d>=l){var a=handleTotalReportData(u);c(true,a)}},function(e){rtcLog.error("get state failed! index = "+s);d++;if(d>=l){var t=handleTotalReportData(u);c(true,t)}})})(e)}}function getQualityReportFronSafariAsync(t,r){var n=Object.keys(t).length;var i=0;if(n===0){rtcLog.warn("get quality async failed! peerconnection size is 0!");r(false,null);return}var e=0;if(navigator&&navigator.cpuMaxFrequency){e=navigator.cpuMaxFrequency}var o=0;if(WebRTCAPI.GLOBAL.LocalStream){var a=WebRTCAPI.GLOBAL.LocalStream.getAudioTracks();if(a&&a[0]&&a[0].muted){o=3}else{o=1}}var s={};var c={};var f={WebRTCQualityReq:{uint64_begine_utime:(new Date).getTime(),uint64_end_utime:0,uint32_real_num:0,uint32_delay:0,uint32_CPU_curfreq:e,uint32_total_send_bps:0,uint32_total_recv_bps:0,AudioReportState:{uint32_audio_enc_pkg_br:0,uint32_audio_real_recv_pkg:0,uint32_audio_flow:0,uint32_audio_real_recv_br:0,uint32_audio_delay:0,uint32_audio_jitter:0,uint32_microphone_status:o,AudioDecState:[]},VideoReportState:{uint32_video_delay:0,uint32_video_snd_br:0,uint32_video_total_real_recv_pkg:0,uint32_video_rcv_br:0,uint32_send_total_pkg:0,VideoEncState:[{uint32_enc_width:0,uint32_enc_height:0,uint32_capture_fps:0,uint32_enc_fps:0}],VideoDecState:[]}}};for(var p in t){(function(u){var e=t[u];e.getStats().then(function(e){var l={uint32_video_recv_fps:0,uint32_video_recv_br:0,uint32_video_real_recv_pkg:0,uint32_dec_height:0,uint32_dec_width:0,uint32_video_jitter:0,uint64_sender_uin:""};var d={uint32_audio_delay:0,uint32_audio_jitter:0,uint32_audio_real_recv_pkg:0,uint32_audio_flow:0,uint32_audio_real_recv_br:0,uint64_sender_uin:""};e.forEach(function(e){var t=e.type;if(t==="inbound-rtp"&&u!=0){var r=e["id"];var n=null;if(!!r){if(r.toLowerCase().indexOf("video")!==-1){n="video"}else if(r.toLowerCase().indexOf("audio")!==-1){n="audio"}}if(n==="video"||n==="audio"){var i=e["bytesReceived"]||"0";var o=e["packetsReceived"]||"0";if(n==="video"){f.WebRTCQualityReq.VideoReportState.uint32_video_rcv_br+=parseInt(i);f.WebRTCQualityReq.VideoReportState.uint32_video_total_real_recv_pkg=parseInt(o);l.uint64_sender_uin=p;l.uint32_video_real_recv_pkg=parseInt(o);l.uint32_video_recv_br=parseInt(i);l.uint32_video_jitter=e["jitter"]*1e3}else{f.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_br+=parseInt(i);f.WebRTCQualityReq.AudioReportState.uint32_audio_real_recv_pkg+=parseInt(o);f.WebRTCQualityReq.AudioReportState.uint32_audio_flow+=parseInt(i);d.uint64_sender_uin=u;d.uint32_audio_real_recv_pkg=parseInt(o);d.uint32_audio_flow=parseInt(i);d.uint32_audio_jitter=e["jitter"]*1e3}}}else if(t==="outbound-rtp"&&u=="0"){var n=e["mediaType"];if(n==="video"||n==="audio"){var a=e["bytesSent"]||"0";var s=e["packetsSent"]||"0";if(n==="video"){f.WebRTCQualityReq.VideoReportState.uint32_video_snd_br+=parseInt(a);f.WebRTCQualityReq.VideoReportState.uint32_send_total_pkg=parseInt(s)}else{f.WebRTCQualityReq.AudioReportState.uint32_audio_enc_pkg_br+=parseInt(a)}}}else if(t==="track"){var r=e["id"];if(u=="0"){}else{if(!!r&&r.toLowerCase().indexOf("video")!==-1){l.uint32_video_recv_fps=parseInt(e["framesPerSecond"]||"0");l.uint32_dec_width=parseInt(e["frameWidth"]);l.uint32_dec_height=parseInt(e["frameHeight"])}}}else if(t==="candidate-pair"){var c=e["currentRoundTripTime"]*1e3;if(u=="0"){f.WebRTCQualityReq.uint32_delay=c}else{}}});if(u!="0"){f.WebRTCQualityReq.AudioReportState.AudioDecState.push(d);f.WebRTCQualityReq.VideoReportState.VideoDecState.push(l)}i++;if(i>=n){f=parseFinalReport(f,true);r(true,f)}}).catch(function(e){i++;if(i>=n){f=parseFinalReport(f,true);r(true,f)}})})(p)}}var reportQuality=function(){if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_OPEN){uploadWebLog("start report quality data",null,global.KEY_TAG.RTC_LOG_TAG)}if(!global.websocket){rtcLog.error("report quality data end, websocket is null!");uploadWebLog("report quality data end, websocket is null!",null,global.KEY_TAG.RTC_LOG_TAG);return}if((new Date).valueOf()-global.reportTime>5e3){var e="report quality time out, pre report time "+global.reportTime+" this report time "+(new Date).valueOf();rtcLog.error(e);uploadWebLog(e,null,global.KEY_TAG.REPORT_TIME_OUT_TAG)}if(!isSafari()){getQulityAsync(global.peerConnections,function(e,t){var r=createJsonFromTag(global.RTC_EVENT.ON_QUALITY_REPORT);if(!e){r.data=handleTotalReportData({})}else{rtcLog.debug("get qualityData : "+JSON.stringify(t));r.data=t;if(rtclistener.config.onQualityReport){rtclistener.config.onQualityReport(t)}}r.data=addCommonInfoInQualityReport(r.data,global.ostype,global.ostype,global.relayip,global.localip,global.config.tinyid,global.roomid,global.cpunum,global.cpunam);try{if(global.websocket){global.websocket.send(JSON.stringify(r));if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_OPEN){uploadWebLog("report quality data send!",null,global.KEY_TAG.RTC_LOG_TAG)}global.reportTime=(new Date).valueOf()}}catch(e){rtcLog.error("websocket send data error : "+e.message);uploadWebLog("[QUALITY REPORT]websocket send data error : "+e.message,null,global.KEY_TAG.RTC_LOG_TAG)}})}else{getQualityReportFronSafariAsync(global.peerConnections,function(e,t){var r=createJsonFromTag(global.RTC_EVENT.ON_QUALITY_REPORT);if(!e){rtcLog.error("[GetQualityReportFronSafariAsync] failed! ");r.data=handleTotalReportData({})}else{rtcLog.debug("get qualityData : "+JSON.stringify(t));r.data=t;if(rtclistener.config.onQualityReport){rtclistener.config.onQualityReport(t)}}r.data=addCommonInfoInQualityReport(r.data,global.ostype,global.ostype,global.relayip,global.localip,global.config.tinyid,global.roomid,global.cpunum,global.cpunam);try{if(global.websocket){global.websocket.send(JSON.stringify(r));if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_OPEN){uploadWebLog("report quality data send!",null,global.KEY_TAG.RTC_LOG_TAG)}global.reportTime=(new Date).valueOf()}}catch(e){rtcLog.error("websocket send data error : "+e.message);uploadWebLog("websocket send data error : "+e.message,null,global.KEY_TAG.RTC_LOG_TAG)}})}};function cloneObj(e){var t,r=e.constructor===Array?[]:{};if(typeof e!=="object"){return}else if(window.JSON){t=JSON.stringify(e),r=JSON.parse(t)}else{for(var n in e){r[n]=typeof e[n]==="object"?cloneObj(e[n]):e[n]}}return r}function isSafari(){return WebRTCStat.getExplore().toLowerCase().indexOf("safari")!==-1}var createJsonFromTag=function(e){return{tag_key:e,data:"",openid:global.config.openid,tinyid:global.config.tinyid,version:global.VERSION,ua:navigator.userAgent,sessionid:global.roomid}};var sendSdp=function(e,t){var r=createJsonFromTag(global.RTC_EVENT.ON_PEER_SDP);r.data=e;r.srctinyid=t;global.websocket.send(JSON.stringify(r))};var sendUpdateSdp=function(e,t){var r=createJsonFromTag(global.RTC_EVENT.ON_UPDATE_PEER_SDP);r.data=e;r.srctinyid=t;global.websocket.send(JSON.stringify(r))};var changeLocalMedia=function(e,t){rtcLog.debug("change local media : is video : "+e+" , is open = "+t);if(!global.localStream){rtcLog.error("change local media failed! local media is null");return false}var r=null;var n=0;if(e){r=global.localStream.getVideoTracks();if(t){n=global.MEDIA_CHANGE.OPEN_VIDEO}else{n=global.MEDIA_CHANGE.CLOSE_VIDEO}}else{r=global.localStream.getAudioTracks();if(t){n=global.MEDIA_CHANGE.OPEN_AUDIO}else{n=global.MEDIA_CHANGE.CLOSE_AUDIO}}for(var i=0;i<r.length;i++){r[i].enabled=t}if(global.websocket){var o=createJsonFromTag(global.RTC_EVENT.ON_MEDIA_CHANGE);o.data={mediatype:n};global.websocket.send(JSON.stringify(o))}return true};webrtc.uploadWebLog=function(e,t,r){uploadWebLog(e,t,r)};webrtc.init=function(e,t){global.config.userSig=e.userSig;global.config.openid=e.openid;global.config.sdkAppId=e.sdkAppId;global.config.accountType=e.accountType;global.config.srctinyid=e.srctinyid;global.config.closeLocalMedia=e.closeLocalMedia;global.config.videoActive=typeof e.video!=="undefined"?e.video:true;global.config.audioActive=typeof e.audio!=="undefined"?e.audio:true;global.config.isScreenShare=typeof e.screen!=="undefined"?e.screen:false;try{navigator.mediaDevices.enumerateDevices().then(function(e){e.forEach(function(e){if(e.kind==="videoinput"){global.deviceInfo.hasVideo=true}if(e.kind==="audioinput"){global.deviceInfo.hasAudio=true}});initWebSocket(function(e){t(e)})}).catch(function(e){uploadWebLog("WEBRTC--enumeadevice failed!!! failed = "+e.message,null,"ENUM_DEVICE");global.deviceInf.hasVideo=true;global.deviceInf.hasAudio=true;initWebSocket(function(e){t(e)})})}catch(e){uploadWebLog("WEBRTC--enumeadevice failed!!! failed = "+e.message,null,"ENUM_DEVICE");global.deviceInf.hasVideo=true;global.deviceInf.hasAudio=true;initWebSocket(function(e){t(e)})}return 0};var startWebRTCCalllback=function(e){if(e!==0){var t="";if(e===-10007){t="PeerConnection 创建失败"}else if(e===-10008){t="getUserMedia 失败"}else if(e===-10009){t="getLocalSdp 失败"}else if(e===-50002){t="屏幕分享不能切换摄像头"}else if(e===-50003){t="getUserScreenMedia 失败"}else{t="start WebRTC failed!!!"}webrtc.quit();console.error("code",e,", errorMsg:",t)}};webrtc.createRoom=function(e,t){rtclistener.config.onCreateRoomResult=t;if(!global.config.openid)return;var r,n="";if(typeof e==="object"){r=e.roomid;n=e.role}else{r=e}if(!Number.isInteger(Number(r))){console.error("[房间号](roomid) "+r+" 输入有误，请使用32位整数");return}openRoom(global.config.openid,global.config.tinyid,r,n,global.config.userSig)};webrtc.setlistener=function(e){return setlistener(e)};webrtc.quit=function(){if(global.reportSto){clearInterval(global.reportSto)}global.reportSto=null;global.preReportData=null;endEndReport(0);if(global.localStream){global.localStream.getTracks().forEach(function(e){e.stop()});global.localStream=null}if(global.peerConnections){for(var e in global.peerConnections){var t=global.peerConnections[e];if(t){if(t.signalingState!=="closed"){t.close()}t=null}}global.peerConnections={}}if(global.websocket){global.websocket.close();global.websocket=null}clearGlobalValues()};webrtc.closeAudio=function(){return changeLocalMedia(false,false)};webrtc.closeVideo=function(){return changeLocalMedia(true,false)};webrtc.openAudio=function(){return changeLocalMedia(false,true)};webrtc.openVideo=function(){return changeLocalMedia(true,true)};webrtc.setMicVolume=function(e){if(global.gainNode)global.gainNode.gain.value=e};webrtc.setConstraints=function(e){if(e.width&&e.height||e.frameRate||e.audio||e.video){rtcLog.info("用户指定constraints",e);var t={VidWidth:e.width,VidHeight:e.height,VidFr:e.frameRate||20,CpuOverUseDetect:false};if(e.audio){t.audio=e.audio}if(e.video){t.video=e.video}global.specifyConstraints=t;return true}else{global.specifyConstraints=null}return false};webrtc.changeSpearRole=function(e){var t=createJsonFromTag(global.RTC_EVENT.ON_SPEAR_ROLE_CHANGE);t.data={role:e};global.websocket.send(JSON.stringify(t))};webrtc.getOpenId=function(e){return global.openIdMap[e]||null};webrtc.getMaxTimeMs=function(e){rtcLog.debug("request maximun timestamp");var t=createJsonFromTag(global.RTC_EVENT.ON_GET_MAX_TIMEMS);t.data={};global.websocket.send(JSON.stringify(t));onGetMaxTimeMs=e};webrtc.startWebRTC=function(i,o){if(rtclistener.config.onUserDefinedWebRTCEventNotice){rtclistener.config.onUserDefinedWebRTCEventNotice(global.USER_DEFINED_EVENT.BEGIN_START_WEBRTC,null)}rtcLog.info("start webrtc : src tinyid = "+o);if(global.websocket){var e=createJsonFromTag(global.RTC_EVENT.ON_START_WEBRTC);global.websocket.send(JSON.stringify(e))}if(!i){var t="start webrtc failed! did not set callback";rtcLog.error(t);if(global.websocket){var r=createJsonFromTag(global.RTC_EVENT.ON_START_WEBRTC_FAILED_WITHOUT_CALLBACK);global.websocket.send(JSON.stringify(r))}return false}if(!createPeerConnection(o||0)){rtcLog.error("create peer connection failed!");i(-10007);return}if(parseInt(o||0)===0){getLocalStream(function(e,t){if(e!==0){var r="get local stream failed! exception : "+t;rtcLog.error(r);uploadWebLog(r,null,global.KEY_TAG.RTC_LOG_TAG);if(global.websocket){var n=createJsonFromTag(global.RTC_EVENT.ON_GET_USER_MEDIA_FAILED);n.data=r;global.websocket.send(JSON.stringify(n))}i(e);return}rtclistener.config.onLocalStreamAdd(t);getSdp(o,function(e,t){if(e!==0){var r="get local sdp failed!!! e = "+t;rtcLog.error(r);uploadWebLog(r,null,global.KEY_TAG.RTC_LOG_TAG);i(e);return}sendSdp(t,o);i(0)})})}else{getSdp(o,function(e,t){if(e!==0){rtcLog.error("get local sdp failed!!! e = "+t);i(e);return}sendSdp(t,o);i(0)})}};webrtc.wsreconnect=function(e){if(CURRENT_SERVER_TYPE===SERVER_TYPE.FOR_OPEN){rtcLog.errorMsg("[WSRECONNECT]this interface can only use by edu");return false}if(!e){return false}if(!global.websocket){return false}global.websocket.reconnect(e);return true};webrtc.recreateDataChannel=function(){var e="1";if(global.peerConnections[e]&&global.peerConnections[e].signalingState!=="closed"){global.peerConnections[e].close()}delete global.peerConnections[e];global.peerConnections[e]=null;webrtc.createDataChannel()};webrtc.createDataChannel=function(){rtcLog.debug("createDataChannel");var r="1";createPeerConnection(r);var n=global.peerConnections[r];n.ondatachannel=function(e){rtcLog.info("ondatachannel: "+e)};rtcLog.info("createDataChannel MyDataChannel");var e=n.createDataChannel("MyDataChannel",{reliable:false});e.onmessage=function(e){rtcLog.info("dataChannel received: "+e.data)};e.onopen=function(){rtcLog.info("datachannel open")};e.onclose=function(){rtcLog.info("datachannel close")};e.onerror=function(){rtcLog.info("datachannel onerror")};n.dataChannel=e;var t=global.offerSdpOption;n.createOffer(t).then(function(e){n.setLocalDescription(e)}).then(function(){var e=n.localDescription;rtcLog.info("dcPeerConnection get local sdp info : "+e.sdp);var t=createJsonFromTag(global.RTC_EVENT.ON_PEER_SDP);t.roomid=global.roomid;t.usersig=global.config.userSig;t.sdkappid=global.config.sdkAppId;t.relayip=global.relayip;t.data=e;t.srctinyid=r;global.websocket.send(JSON.stringify(t))}).catch(function(e){rtcLog.error("dcPeerConnection create offer failed : reason = "+e)});return true};webrtc.sendDCData=function(e){var t="1";var r=global.peerConnections[t];if(r){r.dataChannel.send(e)}};webrtc.chooseVideoDevice=function(e){if(typeof global.constraints.video==="object"){global.constraints.video.deviceId=e}else{global.constraints.video={deviceId:e}}var t={audio:global.constraints.audio,video:global.constraints.video};onChangeConstraints(t,false,true)};webrtc.chooseAudioDevice=function(e){if(typeof global.constraints.audio==="object"){global.constraints.audio.deviceId=e}else{global.constraints.audio={deviceId:e}}var t={audio:global.constraints.audio,video:global.constraints.video};onChangeConstraints(t,true,false)}})(webrtc);var PingUtil=function(e,n){var i=0;var o=e;var a=[];var s=function(e){this.opt=e||{};this.favicon=this.opt.favicon||"/favicon.ico";this.timeout=this.opt.timeout||0};s.prototype.ping=function(e,r){this.img=new Image;var n;var i=new Date;this.img.onload=t;this.img.onerror=t;if(this.timeout){n=setTimeout(t,this.timeout)}function t(e){if(n){clearTimeout(n)}var t=new Date-i;if(typeof r==="function"){if(e.type==="error"){console.error("error loading resource");return r("error",t)}return r(null,t)}}this.img.src=e+this.favicon+"?"+ +new Date};function c(){if(i<o){i++;var e=new s;e.ping("https://qcloud.rtc.qq.com:8687",function(e,t){a.push(t);c()})}else{if(a.length==i){var t=0;for(var r=0;r<a.length;r++){t+=a[r]}n(parseInt(t/a.length),a)}else{setTimeout(c,100)}}}c()};(function(n){var a=new function(){this.config={openid:"",userSig:"",sdkAppId:"",accountType:"",srctinyid:""};this.jumpurl=null;this.listener={onKickout:null,onInitResult:null,onWebSocketClose:null,onRelayTimeout:null,onQualityReport:null};this.roomid=0};var e=function(e,t){};var t=function(){};var r=function(e,t){var r=document.createElement("video");r.setAttribute("playsinline","true");r.className="video-item ";r.autoplay=true;r.muted=true;for(var n in t){r[n]=t[n]}return r};var i=function(e,t){var r=document.createElement("audio");r.setAttribute("playsinline","true");r.className="audio-item";r.autoplay=true;for(var n in t){r[n]=t[n]}return r};var o=function(e){console.info("local stream add!!!");a.listener.onLocalStreamAdd(e)};var s=function(e,t){console.info("remote stream add!!!, videoId = "+t);var r=t.split("_")[0];var n=webrtc.getOpenId(r);a.listener.onRemoteStreamAdd(e,t,n)};var c=function(e){console.info("onRemoteStreamUpdate!!!, videoId = "+e.videoId);var t=e.videoId.split("_")[0];e.openId=webrtc.getOpenId(t);a.listener.onRemoteStreamUpdate(e)};var l=function(e){console.info("onPeerStreamRemove!!! videoId = "+e);var t=e.split("_")[0];var r=webrtc.getOpenId(t);a.listener.onRemoteStreamRemove({videoId:e,openId:r})};var d=function(){console.log("on websocket close!");webrtc.quit();if(a.listener.onWebSocketClose){a.listener.onWebSocketClose()}};var u=function(e){if(a.listener.onRelayTimeout){a.listener.onRelayTimeout(e)}};var f=function(e){if(a.listener.onKickout){a.listener.onKickout(e)}};var p=function(){if(a.listener.onIceConnectionClose){a.listener.onIceConnectionClose()}};var g=function(e){if(a.listener.onChangeRemoteStreamState){a.listener.onChangeRemoteStreamState(e)}};var v=function(e){if(a.listener.onQualityReport){a.listener.onQualityReport(e)}};var m=function(e,t){if(a.listener.onIceConnectionBuild){a.listener.onIceConnectionBuild(e,t)}};var _=function(e,t,r){if(a.listener.onKeylogWrite){a.listener.onKeylogWrite(e,t,r)}};var b=function(){if(a.listener.onWebSocketReconnection){a.listener.onWebSocketReconnection()}};var h=function(e,t){if(a.listener.onUserDefinedWebRTCEventNotice){a.listener.onUserDefinedWebRTCEventNotice(e,t)}};var T={onMediaChange:e,onRemoteLeave:t,onLocalStreamAdd:o,onPeerStreamAdd:s,onPeerStreamRemove:l,onRemoteStreamUpdate:c,onWSClose:d,onKickout:f,onRelayTimeout:u,onIceConnectionClose:p,onChangeRemoteStreamState:g,onQualityReport:v,onIceConnectionBuild:m,onKeylogWrite:_,onWebSocketReconnection:b,onUserDefinedWebRTCEventNotice:h};n.init=function(t,e){var r=["onInitResult","onLocalStreamAdd","onRemoteStreamAdd","onRemoteStreamUpdate","onRemoteStreamRemove","onWebSocketClose","onRelayTimeout","onIceConnectionClose","onChangeRemoteStreamState"];var n=[];if(t){r.forEach(function(e){if(!t[e]){n.push(e)}})}if(!t||n.length>0){var i="WebRTC API init failed! listener is incorrect! "+n.join(",");webrtc.uploadWebLog(i,null,"websocket_tag");console.error(i);return-10001}a.listener.onInitResult=t.onInitResult;a.listener.onLocalStreamAdd=t.onLocalStreamAdd;a.listener.onRemoteStreamAdd=t.onRemoteStreamAdd;a.listener.onRemoteStreamUpdate=t.onRemoteStreamUpdate;a.listener.onRemoteStreamRemove=t.onRemoteStreamRemove;a.listener.onWebSocketClose=t.onWebSocketClose;a.listener.onKickout=t.onKickout;a.listener.onRelayTimeout=t.onRelayTimeout;a.listener.onIceConnectionClose=t.onIceConnectionClose;a.listener.onChangeRemoteStreamState=t.onChangeRemoteStreamState;if(t.onIceConnectionBuild){a.listener.onIceConnectionBuild=t.onIceConnectionBuild}if(t.onQualityReport){a.listener.onQualityReport=t.onQualityReport}if(t.onKeylogWrite){a.listener.onKeylogWrite=t.onKeylogWrite}if(t.onWebSocketReconnection){a.listener.onWebSocketReconnection=t.onWebSocketReconnection}if(t.onUserDefinedWebRTCEventNotice){a.listener.onUserDefinedWebRTCEventNotice=t.onUserDefinedWebRTCEventNotice}if(!e||!e.openid||!e.userSig||!e.sdkAppId||!e.accountType){var i="WebRTC API init failed! config is incorrect!";webrtc.uploadWebLog(i,null,"websocket_tag");console.error(i);a.listener.onInitResult({result:-10001,error:"确定参数是否完整"});return 0}a.config=e;var o=false;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){if(o){return}if(e in window){o=true}});if(!o){var i="WebRTC API init failed! browser not support webrtc!";webrtc.uploadWebLog(i,null,"websocket_tag");console.error(i);a.listener.onInitResult({result:-10002,error:"浏览器不支持WebRTC"});return 0}if(e.screen){ScreenChromeExtensionUtil.getChromeExtensionStatus(function(e){if(e==="installed-enabled"){ScreenChromeExtensionUtil.isChromeExtensionAvailable(function(e){if(!e){a.listener.onInitResult({result:-5e4,error:"检查屏幕分享插件是否安装"});return 0}else{webrtc.setlistener(T);return webrtc.init(a.config,function(e){a.listener.onInitResult(e.result,e)})}})}else{a.listener.onInitResult({result:-5e4,error:"检查屏幕分享插件是否安装"});return 0}})}else{webrtc.setlistener(T);return webrtc.init(a.config,function(e){a.listener.onInitResult(e.result,e)})}};n.createRoom=function(e,t){return webrtc.createRoom(e,t)};n.startWebRTC=function(e,t){return webrtc.startWebRTC(e,t)};n.closeAudio=function(){return webrtc.closeAudio()};n.closeVideo=function(){return webrtc.closeVideo()};n.openAudio=function(){return webrtc.openAudio()};n.openVideo=function(){return webrtc.openVideo()};n.setMicVolume=function(e){return webrtc.setMicVolume(e)};n.setConstraints=function(e){return webrtc.setConstraints(e)};n.quit=function(){return webrtc.quit()};n.changeSpearRole=function(e){return webrtc.changeSpearRole(e)};n.getOpenId=function(e){return webrtc.getOpenId(e)};n.ping=function(e,t){return new PingUtil(e,t)};n.wsreconnect=function(e){if(!e){console.error("wsreconnect --\x3e sig is null!");return false}webrtc.wsreconnect(e);return true};n.getMaxTimeMs=function(e){webrtc.getMaxTimeMs(e)};n.createDataChannel=function(){webrtc.createDataChannel()};n.recreateDataChannel=function(){webrtc.recreateDataChannel()};n.sendDCData=function(e){webrtc.sendDCData(e)};n.getDevices=function(i,t){navigator.mediaDevices.enumerateDevices().then(function(e){console.debug(e);var t={},r={};e.forEach(function(e){if(e&&e.kind==="audioinput"){r[e.deviceId]=e}if(e&&e.kind==="videoinput"){t[e.deviceId]=e}});for(var n in t){if(r[n]){delete r[n]}}if(i){i(Object.values(t),Object.values(r))}}).catch(function(e){console.log(e.name+": "+e.message);if(t){t(e)}})};n.getVideoDevices=function(r,t){n.getDevices(function(e,t){if(r){r(e)}},function(e){if(t){t(e)}})};n.chooseVideoDevice=function(e){webrtc.chooseVideoDevice({exact:e.deviceId})};n.getAudioDevices=function(r,t){n.getDevices(function(e,t){if(r){r(t)}},function(e){if(t){t(e)}})};n.chooseAudioDevice=function(e){webrtc.chooseAudioDevice({exact:e.deviceId})};n.setDefaultDevice=function(e,t){var r={};if(e){r["video"]={deviceId:e.deviceId}}if(t){r["audio"]={deviceId:t.deviceId}}n.setConstraints(r)}})(WebRTCAPI)}]);